/*! Thrive Ultimatum - 2018-04-11
* http://www.thrivethemes.com/
* Copyright (c) 2018 Thrive Themes */

var ThriveUlt=ThriveUlt||{};ThriveUlt.util=ThriveUlt.util||{},_.templateSettings={evaluate:/<#([\s\S]+?)#>/g,interpolate:/<#=([\s\S]+?)#>/g,escape:/<#-([\s\S]+?)#>/g},Backbone.ajax=function(){return-1===arguments[0].url.indexOf("_nonce")&&(arguments[0].url+="&_nonce="+ThriveUlt.admin_nonce),Backbone.$.ajax.apply(Backbone.$,arguments)},function(a){ThriveUlt.util.upperFirst=function(a){return a?a.toLowerCase().charAt(0).toUpperCase()+a.slice(1):""},ThriveUlt.util.ajaxModal=function(b){TVE_Dash.showLoader();var c=_.extend({type:"get"},b);a.ajax(c).done(function(a){var c=new TVE_Dash.views.Modal(b);c.data=b,c.template=_.template(a),c.render().open(b),"function"==typeof b.afterOpen&&b.afterOpen.call(c)}).always(function(){TVE_Dash.hideLoader()})},ThriveUlt.util.printf=function(a,b){return b?(b instanceof Array||(b=[b]),_.each(b,function(b){a=a.replace("%s",b)}),a):a},ThriveUlt.util.plural=function(a,b,c){return 1==c?ThriveUlt.util.printf(a,c):ThriveUlt.util.printf(b,c)},ThriveUlt.util.states={normal:"normal",delete:"delete",checked:"checked"},ThriveUlt.util.days={week:7,month:31},ThriveUlt.util.weekdays={weekdays:["S","M","T","W","T","F","S"],weekdays_full:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},ThriveUlt.util.campaignType={absolute:"absolute",rolling:"rolling",evergreen:"evergreen"},ThriveUlt.util.status={running:"running",paused:"paused",archived:"archived"},ThriveUlt.util.rollingType={daily:"daily",weekly:"weekly",monthly:"monthly",yearly:"yearly"},ThriveUlt.util.triggerType={conversion:"conversion",first:"first",url:"url",promotion:"promotion"},ThriveUlt.util.triggerVisit={conversion:"Thrive Leads Conversion",first:"first page visit",url:"page visit",linked:"Conversion Event",promotion:"Visit to Promotion Page"},ThriveUlt.util.conversion_event={end:"end",move:"move"},ThriveUlt.util.trigger_type={conversion:"conversion",specific:"specific"},ThriveUlt.util.leadtype={lead_group:"tve_lead_group",shortcode:"tve_lead_shortcode"},ThriveUlt.util.get_type_title=function(a){var b;switch(a){case"absolute":b="Fixed Date";break;case"rolling":b="Recurring";break;case"evergreen":b="Evergreen"}return b+" Campaign"},ThriveUlt.ajaxurl=function(a){var b=-1!==ajaxurl.indexOf("?")?"&":"?";return a&&a.length?(a=a.replace(/^(\?|&)/,""),a+="&_nonce="+ThriveUlt.admin_nonce,ajaxurl+b+a):ajaxurl+b+"_nonce="+ThriveUlt.admin_nonce},ThriveUlt.select_card=function(a,b,c){b.removeClass(c),a.addClass(c)},ThriveUlt.util.ajax_done=function(){},ThriveUlt.util.get_days_and_hours=function(a){return isNaN(a)?[0,0]:a<=23?[0,a]:[parseInt(a/24),a%24]},a.fn.data_name=function(){this.find("select").change(function(){var b=a(this),c=b.val();b.attr("data-name",b.find('option[value="'+c+'"]').text())})},ThriveUlt.util.enter_key_fn=function(b){function c(){return a.isFunction(b)?b():"string"==typeof b||b.jquery?a(b).trigger("click"):void 0}return function(a){13===a.which&&c()}},ThriveUlt.util.isValidHour=function(a){return/^([0-1]?[0-9]|2[0-4]):([0-5][0-9])(:[0-5][0-9])?$/.test(a)},ThriveUlt.util.data_binder=function(b,c){function d(a){return a.is(":checkbox")?!!a.is(":checked"):a.is(":radio")?a.is(":checked")?a.val():"":a.val()}function e(a,c){return a.is(":radio")?b.$el.find('input[name="'+a.attr("name")+'"]:radio').filter('[value="'+c+'"]').prop("checked",!0):a.is(":checkbox")?a.prop("checked",!!c):a.val(c)}if(void 0===c&&(c=b.model),!(!c instanceof Backbone.Model)){var f=b.$el.find("[data-bind]").each(function(){var f=a(this),g=f.attr("data-bind"),h=!1;f.on("change",function(){var a=d(f);c.get(g)!=a&&(h=!0,c.set(g,a),h=!1)}),b.listenTo(c,"change:"+g,function(){h||e(f,this.model.get(g))})});b.listenTo(c,"invalid",function(a,b){_.isArray(b)?_.each(b,function(a){var b=a;a.field&&(b=a.field);var c=f.filter('[data-bind="'+b+'"]').first().addClass("tvd-validate tvd-invalid").focus();a.message&&c.siblings("label").attr("data-error",a.message),(c.is(":radio")||c.is(":checkbox"))&&TVE_Dash.err(c.next("label").attr("data-error"))}):_.isString(b)&&TVE_Dash.err(b)})}},ThriveUlt.util.server_date=function(a){a=a||new Date;var b=Date.UTC(a.getFullYear(),a.getMonth(),a.getDate(),a.getHours(),a.getMinutes(),a.getSeconds(),a.getMilliseconds()),c=b-a.getTime();return b=b+3600*ThriveUlt.wp_timezone_offset*1e3-2*c,a.setTime(b),a},ThriveUlt.util.bind_wistia=function(){window.rebindWistiaFancyBoxes&&window.rebindWistiaFancyBoxes()}}(jQuery);var ThriveUlt=ThriveUlt||{};ThriveUlt.models=ThriveUlt.models||{},ThriveUlt.collections=ThriveUlt.collections||{},function(a){Backbone.emulateHTTP=!0,ThriveUlt.models.Base=Backbone.Model.extend({idAttribute:"ID",toDeepJSON:function(){var b=a.extend(!0,{},this.attributes);return _.each(_.keys(b),function(a){_.isUndefined(b[a])||_.isNull(b[a])||!_.isFunction(b[a].toJSON)||(b[a]=b[a].toJSON())}),b},deepClone:function(){return new this.constructor(this.toDeepJSON())},ensureCollectionData:function(a,b){_.each(b,_.bind(function(b,c){return!a[c]||(this.get(c)instanceof b?(this.get(c).reset(a[c]),void(a[c]=this.get(c))):(a[c]=new b(a[c]),!0))},this))},validation_error:function(a,b){return{field:a,message:b}}}),ThriveUlt.collections.Base=Backbone.Collection.extend({last:function(){return this.at(this.size()-1)}}),ThriveUlt.models.Settings=ThriveUlt.models.Base.extend({defaults:{ID:""},url:function(){return ThriveUlt.ajaxurl("action="+ThriveUlt.ajax_actions.admin_controller+"&route=dateSettings")},validate:function(a,b){var c=[];if(a.offset||c.push(ThriveUlt.t.Timezone_required),c.length)return c}}),ThriveUlt.models.Campaign=ThriveUlt.models.Base.extend({defaults:{ID:"",rolling_type:"",status:ThriveUlt.util.status.paused,impressions:0,has_event_logs:!1,settings:{start:{date:"",time:""},end:"",duration:1,repeat:1,evergreen_repeat:0,repeatOn:[],trigger:[],real:0,realtime:"00:00"},lockdown_settings:{}},get_chart_dummy_data:function(){var a={};return a.conversions=[11,8,14,11,17,12,9,19,17,11,21,13,4],a.impressions=[64,58,89,85,93,75,74,83,88,72,90,82,27],a.labels=_.map(function(){return""},_.range(a.impressions.length)),a},url:function(){var a=ThriveUlt.ajaxurl("action="+ThriveUlt.ajax_actions.admin_controller+"&route=campaigns");return this.get("ID")&&(a+="&ID="+this.get("ID")),a},initialize:function(){this.set("state",ThriveUlt.util.states.normal),this.set("lockdown_state",ThriveUlt.util.states.normal)},createModelCollections:function(){!this.get("display_settings")||this.get("display_settings")instanceof ThriveUlt.collections.Hangers||(this.set("display_settings",new ThriveUlt.collections.Hangers(this.get("display_settings"))),this.set("display_settings_tpl",new ThriveUlt.models.TemplateList(this.get("display_settings_tpl")))),!this.get("designs")||this.get("designs")instanceof ThriveUlt.collections.Designs||this.set("designs",new ThriveUlt.collections.Designs(this.get("designs"))),!this.get("timeline")||this.get("timeline")instanceof ThriveUlt.collections.Events||this.set("timeline",new ThriveUlt.collections.Events(this.get("timeline")))},parse:function(a){if(a.state=ThriveUlt.util.states.normal,a.settings&&(a.settings_collection=new ThriveUlt.collections.RollingCollection,a.settings_collection.setOptions(a.settings.duration,a.rolling_type,a.settings.repeatOn)),a.linked_to){var b=new ThriveUlt.collections.LinkedToCollection;_.each(a.linked_to,function(a){var c=ThriveUlt.globals.campaigns.findWhere({ID:parseInt(a)});b.add(c)}),a.linked_to=b}return a.display_settings&&(a.display_settings=new ThriveUlt.collections.Hangers(a.display_settings),a.display_settings_summary=a.display_settings.get_display_summary(),a.display_settings_tpl=new ThriveUlt.models.TemplateList(a.display_settings_tpl)),a.lockdown_settings&&a.lockdown_settings.promotion&&(a.lockdown_settings.promotion=new ThriveUlt.collections.PromotionURLCollection(a.lockdown_settings.promotion)),this.ensureCollectionData(a,{timeline:ThriveUlt.collections.Events,designs:ThriveUlt.collections.Designs,conversion_events:ThriveUlt.collections.ConversionEvents}),a},validate:function(a,b){var c=[];return a.post_title||c.push(this.validation_error("post_title",ThriveUlt.t.InvalidName)),c.length?c:a.skip_settings_validation?void 0:a.type?(a.type&&"function"==typeof this["validate_"+a.type]&&this["validate_"+a.type](a,c),a.lockdown&&this.validate_lockdown(a,c),c.length?c:void 0):(c.push(ThriveUlt.t.Choose_campaign_type),c)},validate_lockdown:function(a,b){var c=a.lockdown_settings;if(!a.settings_modal){if((!c.preaccess||c.preaccess instanceof Array&&0===c.preaccess.length)&&b.push(this.validation_error("preaccess",ThriveUlt.t.Pre_access_required)),(!c.promotion||0==c.promotion.length||c.promotion instanceof Object&&!c.promotion.at(0).get("id"))&&b.push(this.validation_error("promotion",ThriveUlt.t.Promotion_required)),(!c.expired||c.expired instanceof Array&&0===c.expired.length)&&b.push(this.validation_error("expired",ThriveUlt.t.Expired_required)),b.length)return b;var d=[];return c.preaccess.value===c.promotion.value&&(d=[ThriveUlt.t.promotion,ThriveUlt.t.pre_access],b.push(this.validation_error("promotion",ThriveUlt.util.printf(ThriveUlt.t.SamePage,d)))),c.promotion.value===c.expired.value&&(d=[ThriveUlt.t.expired,ThriveUlt.t.promotion],b.push(this.validation_error("expired",ThriveUlt.util.printf(ThriveUlt.t.SamePage,d)))),b.length?b:void 0}},validate_rolling:function(b,c){var d=b.settings,e=ThriveUlt.util.server_date(),f=parseInt(d.duration),g=new Date(d.start.date+" "+d.start.time);if(a.trim(d.start.date)||c.push(this.validation_error("start_date",ThriveUlt.t.Start_date_required)),a.trim(d.start.time)||c.push(this.validation_error("start_time",ThriveUlt.t.Start_time_required)),a.trim(d.start.time)&&!ThriveUlt.util.isValidHour(d.start.time)&&c.push(this.validation_error("start_time",ThriveUlt.t.InvalidHour)),(!a.trim(d.duration).match(/\d+/)||isNaN(f)||f<1)&&c.push(this.validation_error("duration",ThriveUlt.t.Invalid_duration)),c.length)return c;if("new"===b.edit_mode&&e>g){var h=this._same_day(e,g)?ThriveUlt.t.Start_hour_in_the_past:ThriveUlt.t.InvalidStartDateToday;c.push(this.validation_error(this._same_day(e,g)?"start_time":"start_date",h))}if(b.rolling_type===ThriveUlt.util.rollingType.daily&&f>24&&c.push(this.validation_error("duration",ThriveUlt.util.printf(ThriveUlt.t.InvalidDurationTime,24))),b.rolling_type===ThriveUlt.util.rollingType.weekly&&f>7&&c.push(this.validation_error("duration",ThriveUlt.util.printf(ThriveUlt.t.InvalidDurationTime,7))),b.rolling_type===ThriveUlt.util.rollingType.monthly&&f>31&&c.push(this.validation_error("duration",ThriveUlt.util.printf(ThriveUlt.t.InvalidDurationTime,31))),b.rolling_type===ThriveUlt.util.rollingType.yearly&&f>365&&c.push(this.validation_error("duration",ThriveUlt.util.printf(ThriveUlt.t.InvalidDurationTime,365))),null!==d.end&&"object"==typeof d.end){a.trim(d.end.date)||c.push(this.validation_error("end_date",ThriveUlt.t.End_date_required)),a.trim(d.end.time)||c.push(this.validation_error("end_time",ThriveUlt.t.End_time_required)),a.trim(d.end.time)&&!ThriveUlt.util.isValidHour(d.end.time)&&c.push(this.validation_error("end_time",ThriveUlt.t.InvalidEndHour));if(new Date(d.end.date+" "+d.end.time)<=g){var i=d.start.date===d.end.date?ThriveUlt.t.End_after_start_time:ThriveUlt.t.End_after_start_date;c.push(this.validation_error(d.start.date===d.end.date?"end_time":"end_date",i))}}if("string"==typeof d.end&&(a.trim(d.end)||c.push(this.validation_error("occurrences_number",ThriveUlt.t.OccurrencesRequired)),a.trim(d.end)&&(isNaN(d.end)||d.end<=0)&&c.push(this.validation_error("occurrences_number",ThriveUlt.t.InvalidOccurrences))),c.length)return c;b.rolling_type!==ThriveUlt.util.rollingType.weekly&&b.rolling_type!==ThriveUlt.util.rollingType.monthly||0===b.settings.repeatOn.length&&c.push(ThriveUlt.t.InvalidRepeatOn)},validate_evergreen:function(b,c){var d=b.settings,e=parseInt(d.duration),f=parseInt(d.end);return(!a.trim(d.duration).match(/^\d+$/)||isNaN(e)||e<1)&&c.push(this.validation_error("duration",ThriveUlt.t.Invalid_duration)),1==parseInt(d.evergreen_repeat)&&(!a.trim(d.end).match(/^\d+$/)||isNaN(f)||f<1)&&c.push(this.validation_error("end",ThriveUlt.t.Invalid_end_evergreen)),c.length?c:(d.trigger.type===ThriveUlt.util.triggerType.url&&""==d.trigger.ids&&c.push(this.validation_error("post_search",ThriveUlt.t.Choose_trigger_page)),c.length?c:void(b.linked_to||"evergreen"==b.edit_mode||(""===d.trigger.type&&c.push(ThriveUlt.t.InvalidTriggerIds),d.trigger.type===ThriveUlt.util.triggerType.url&&""==d.trigger.ids&&c.push(ThriveUlt.t.InvalidPost),d.trigger.type===ThriveUlt.util.triggerType.conversion&&0===d.trigger.ids.length&&c.push(ThriveUlt.t.InvalidLeadGroup))))},validate_absolute:function(b,c){var d=ThriveUlt.util.server_date(),e=b.settings.start,f=b.settings.end,g=new Date(e.date+" "+e.time),h=new Date(f.date+" "+f.time);if(a.trim(e.date)||c.push(this.validation_error("start_date",ThriveUlt.t.Start_date_required)),a.trim(e.time)||c.push(this.validation_error("start_time",ThriveUlt.t.Start_time_required)),a.trim(f.date)||c.push(this.validation_error("end_date",ThriveUlt.t.End_date_required)),a.trim(f.time)||c.push(this.validation_error("end_time",ThriveUlt.t.End_time_required)),c.length)return c;if("new"===b.edit_mode&&h<d){var i=this._same_day(d,g)?ThriveUlt.t.End_hour_in_the_past:ThriveUlt.t.InvalidEndDateToday;c.push(this.validation_error(this._same_day(d,g)?"end_time":"end_date",i))}if(h<=g){var j=e.date===f.date?ThriveUlt.t.End_after_start_time:ThriveUlt.t.End_after_start_date;c.push(this.validation_error(e.date===f.date?"end_time":"end_date",j))}return c.length?c:void 0},_same_day:function(a,b){return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()},getDisplaySettingsUrl:function(){return ThriveUlt.ajaxurl("action="+ThriveUlt.ajax_actions.admin_controller+"&route=displaySettingsCampaign&campaign_id="+this.get("ID"))},saveStatus:function(b){var c=this;return a.ajax({url:ThriveUlt.ajaxurl(),dataType:"json",method:"POST",data:{_nonce:ThriveUlt.admin_nonce,action:ThriveUlt.ajax_actions.admin_controller,route:"campaignStatus",ID:this.get("ID"),status:b}}).done(function(a){c.set("status",b)})},cleanModel:function(){var a=this.get("type");if(a===ThriveUlt.util.campaignType.absolute)this.get("settings").repeat=1,this.get("settings").duration=1,this.get("settings").repeatOn=[],this.set("rolling_type",""),this.get("settings").trigger={type:"",ids:""},this.get("settings").real=0,this.get("settings").realtime="00:00";else if(a===ThriveUlt.util.campaignType.evergreen){this.get("settings").repeatOn=[],this.set("rolling_type",""),this.get("settings").start={date:"",time:""};var b=this.get("settings").evergreen_repeat;b&&0!==parseInt(b)||(this.get("settings").end="")}else this.get("settings").trigger={type:"",ids:""},this.get("settings").real=0,this.get("settings").realtime="00:00"},changeRepeat:function(a){var b="",c=this.get("rolling_type");return a?(b=a.target.value,this.get("settings").repeat=b):b=this.get("settings").repeat,c||(c=ThriveUlt.util.rollingType.daily),c=c===ThriveUlt.util.rollingType.daily?1==b?c.replace("ily","y"):c.replace("ily","ys"):1==b?c.replace("ly",""):c.replace("ly","s"),1==b&&(b=""),b+" "+c},getSummary:function(){var b=this.get("type"),c="";if(b===ThriveUlt.util.campaignType.rolling){var d=this.changeRepeat(),e=this.get("settings_collection").prepareAppend(),f=this.get("rolling_type");if(f==ThriveUlt.util.rollingType.daily||f==ThriveUlt.util.rollingType.yearly||!f)return void this.set("summary",ThriveUlt.util.printf(ThriveUlt.t.SummaryRunsDayYear,[d]));this.set("summary",ThriveUlt.util.printf(ThriveUlt.t.SummaryRuns,[d,e]))}else{if(b===ThriveUlt.util.campaignType.absolute){var g=this.get("settings").start,c=this.get("settings").end,h=new Date(g.date+" "+g.time),i=new Date(c.date+" "+c.time),j=(i.getTime()-h.getTime())/1e3,k=[a.datepicker.formatDate(ThriveUlt.date_format,h)+" "+a().timepicker.formatTime(ThriveUlt.time_format,h)],l=Math.floor(j/86400),m=Math.floor((j-86400*l)/3600);l&&k.push(ThriveUlt.util.plural(ThriveUlt.t.count_day,ThriveUlt.t.count_days,l)),m&&k.push(ThriveUlt.util.plural(ThriveUlt.t.count_hour,ThriveUlt.t.count_hours,m));var n=ThriveUlt.util.printf(l&&m&&m>0?ThriveUlt.t.SummaryStartsDaysHours:ThriveUlt.t.SummaryStarts,k);return this.set("summary",n)}var o=this.get("settings").trigger.type,p="",l="";c=b===ThriveUlt.util.campaignType.evergreen?this.get("settings").duration:this.get("settings").end,l=1==c?"day":"days",p=o?o===ThriveUlt.util.triggerType.url?ThriveUlt.util.triggerVisit.url:o===ThriveUlt.util.triggerType.first?ThriveUlt.util.triggerVisit.first:o===ThriveUlt.util.triggerType.promotion?ThriveUlt.util.triggerVisit.promotion:ThriveUlt.util.triggerVisit.conversion:ThriveUlt.util.triggerVisit.linked,this.set("summary",ThriveUlt.util.printf(ThriveUlt.t.SummaryStartsEvergreen,[p,c,l]))}},checkDesignsTemplate:function(){var a=this.get("designs"),b="";return a.each(function(a){var c=a.get("tpl");c&&(b=c)},this),!!b},setTime:function(a){return this.get("settings").end=null!==this.get("settings").end&&"object"==typeof this.get("settings").end?this.get("settings").end:{date:"",time:""},this.get("settings").end.time=a,this},has_design_type:function(a){return"string"!=typeof a||!a.length||"shortcode"!==a&&void 0!==this.get("designs").findWhere({post_type:a})},can_set_events:function(){return this.get("type")},get_settings_step:function(){return this.get("display_settings")?this.get("type")?ThriveUlt.data.lead_groups&&ThriveUlt.data.shortcodes||this.get("settings").trigger.type!=ThriveUlt.util.triggerType.conversion?this.get("type")!=ThriveUlt.util.campaignType.evergreen||this.get("lockdown")||this.get("settings").trigger.type!=ThriveUlt.util.triggerType.promotion?this.get("display_settings").has_saved_options()?!this.get("lockdown")||0!=this.get("lockdown_settings").preaccess.length&&0!=this.get("lockdown_settings").expired.length&&0!=this.get("lockdown_settings").promotion.length?this.get("designs").size()?this.get("timeline").size()<=2&&!this.get("timeline").at(0).get("actions").size()?"timeline":"":"design":"lockdown":"display":"lockdown_type":"leads_missing":"type":"display"},load_chart_data:function(b){return this.get("ID")?this.has("chart_data")?b.call(null,this.get("chart_data")):void a.ajax({url:this.url(),data:{custom:"chart_data",_nonce:ThriveUlt.admin_nonce},type:"post",dataType:"json"}).done(_.bind(function(a){this.set("chart_data",a),b.call(null,this.get("chart_data"))},this)).fail(_.bind(function(){b.call(null,null)},this)):null},roundTime:function(a){if(a){var b=a.slice(-2),c=a.slice(0,2);return b>30&&c++,b="00",c+":"+b}return""},_is_type:function(a){return this.get("type")&&this.get("type")===a},is_evergreen:function(){return this._is_type(ThriveUlt.util.campaignType.evergreen)},is_absolute:function(){return this._is_type(ThriveUlt.util.campaignType.absolute)},is_rolling:function(){return this._is_type(ThriveUlt.util.campaignType.rolling)},has_valid_lockdown_trigger:function(){if(!this.is_evergreen())return!0;var b=this.get("settings");return!!(b.trigger&&a.isPlainObject(b.trigger)&&b.trigger.type)&&(b.trigger.type===ThriveUlt.util.triggerType.conversion||b.trigger.type===ThriveUlt.util.triggerType.promotion)},is_archived:function(){return this.get("status")===ThriveUlt.util.status.archived},is_running:function(){return this.get("status")===ThriveUlt.util.status.running},get_archive_tooltip:function(){return this.get("status")===ThriveUlt.util.status.archived?ThriveUlt.t.restore_campaign:ThriveUlt.t.archive_campaign}}),ThriveUlt.models.CheckboxModel=ThriveUlt.models.Base.extend({defaults:{ID:"",checked:!1,label:"",disabled:!1}}),ThriveUlt.models.LeadGroupModel=ThriveUlt.models.Base.extend({}),ThriveUlt.collections.LeadGroupsCollection=ThriveUlt.collections.Base.extend({model:ThriveUlt.models.LeadGroupModel}),ThriveUlt.models.ShortcodeModel=ThriveUlt.models.Base.extend({}),ThriveUlt.collections.ShortcodesCollection=ThriveUlt.collections.Base.extend({model:ThriveUlt.models.ShortcodeModel}),ThriveUlt.models.PromotionURLModel=ThriveUlt.models.Base.extend({idAttribute:"ID",defaults:{id:"",label:"",type:"",value:"",link:""}}),ThriveUlt.collections.PromotionURLCollection=ThriveUlt.collections.Base.extend({model:ThriveUlt.models.PromotionURLModel,generateEmailLink:function(){function b(a,b){return a=a+(a.indexOf("?")>0?"&":"?")+"tu_id="+d.get("ID")+"&tu_em="+b}var c=this.model,d=this.parent_model,e=a("#tvu-autoresponder-type"),f=e.find("option:selected").data("tag"),g=this.$(".tvu-email-link");if(f=f||"[email]",!(c instanceof Array&&0===c.length)){if(null!==c&&!c.get("id")&&c.get("value")){var h=b(c.get("value"),f);return void c.set("link",h)}var i=ajaxurl+"?action="+ThriveUlt.ajax_actions.admin_controller+"&route=getPostByID",j={id:c.get("id"),_nonce:ThriveUlt.admin_nonce};g.val(ThriveUlt.t.Loading),a.ajax({method:"POST",url:i,data:j,success:function(a){var d=b(a.url,f);c.set({link:d})}})}},cleanCollection:function(){var a=[];return this.at(0).get("id")?(this.length>1&&_.each(this.where({id:""}),function(a){this.remove(a,{silent:!0})},this),a):(a.push(this.at(0).validation_error("promotion",ThriveUlt.t.Promotion_required)),a)}}),ThriveUlt.collections.RollingCollection=ThriveUlt.collections.Base.extend({model:ThriveUlt.models.CheckboxModel,setOptions:function(a,b,c){var d=0,e=a-1,f=2*e+1,g=this;if(b===ThriveUlt.util.rollingType.weekly){var h=ThriveUlt.util.weekdays.weekdays;d=ThriveUlt.util.days.week}else b===ThriveUlt.util.rollingType.monthly&&(d=ThriveUlt.util.days.month);this.reset();for(var i=0;i<d;i++)this.add(new ThriveUlt.models.CheckboxModel({checked:_.contains(c,i),ID:i,label:h?h[i]:i+1,disabled:!1}));var j=this.where({checked:!0});return j&&_.each(j,function(a){for(var b=a.get("ID"),c=0;c<d;c++){(c-b<0?b-c+e:c-b+e)%d<f&&c!==b&&g.at(c).set("disabled",!0)}}),this},changeCheckboxes:function(a,b){for(var c=this.length,d=a-1,e=2*d+1,f=this.at(b).get("checked"),g=this,h=0;h<c;h++){(h-b<0?b-h+d:h-b+d)%c<e&&h!==b&&this.at(h).set("disabled",!f)}var i=this.where({checked:!0});i&&1==f&&_.each(i,function(a){if(a.get("ID")!==b)for(var f=a.get("ID"),h=0;h<c;h++){var i=h-f<0?f-h+d:h-f+d;i%c<e&&h!==f&&g.at(h).set("disabled",!0)}})},getIDsArray:function(){var a=this.where({checked:!0}),b=[];return _.each(a,function(a){b.push(a.get("ID"))}),b},prepareAppend:function(){var a=this.where({checked:!0}),b=this,c="",d=a[a.length-1],e=a[0];return _.each(a,function(f){if(7===b.length){var g=ThriveUlt.util.weekdays.weekdays_full;a.length>1&&d.get("ID")===f.get("ID")?c+=" and "+g[f.get("ID")]:a.length>=1&&e.get("ID")===f.get("ID")?c+=" "+g[f.get("ID")]:c+=", "+g[f.get("ID")]}else{var h=f.get("ID")+1,i=h%10,j=h%100;a.length>1&&d.get("ID")===f.get("ID")?c+=1==i&&11!=j?" and "+h+"st":2==i&&12!=j?" and "+h+"nd":3==i&&13!=j?" and "+h+"rd":" and "+h+"th":a.length>=1&&e.get("ID")===f.get("ID")?c+=1==i&&11!=j?" "+h+"st":2==i&&12!=j?" "+h+"nd":3==i&&13!=j?" "+h+"rd":" "+h+"th":c+=1==i&&11!=j?", "+h+"st":2==i&&12!=j?", "+h+"nd":3==i&&13!=j?", "+h+"rd":", "+h+"th"}}),c}}),ThriveUlt.collections.Campaigns=ThriveUlt.collections.Base.extend({model:ThriveUlt.models.Campaign,comparator:function(a){return parseInt(a.get("order"))},removeSpecificModel:function(a){var b=this.findWhere({ID:parseInt(a)});return b&&this.remove(b),this},filter_archived:function(a){return void 0===a&&(a=!0),!0===a?this.where({status:ThriveUlt.util.status.archived}):this.filter(function(a){return a.get("status")===ThriveUlt.util.status.paused||a.get("status")===ThriveUlt.util.status.running})}}),ThriveUlt.models.Design=ThriveUlt.models.Base.extend({defaults:{ID:"",state:ThriveUlt.util.states.normal},previous_state:null,initialize:function(a){!this.get("ID")&&a.id&&this.set("ID",a.id),this.on("change:state",_.bind(this.state_changed,this)),!a.children||a.children instanceof ThriveUlt.collections.Designs||this.set("children",new ThriveUlt.collections.Designs(a.children))},state_changed:function(a,b){this.previous_state=b},url:function(){var a=ThriveUlt.ajaxurl("action="+ThriveUlt.ajax_actions.admin_controller+"&route=designs");return this.get("ID")&&(a+="&ID="+this.get("ID")),a},parse:function(a){return a.state||(a.state=this.previous_state?this.previous_state:ThriveUlt.util.states.normal),this.ensureCollectionData(a,{children:ThriveUlt.collections.Designs}),a},thumb:function(){return this.get("thumb_url")?this.get("thumb_url"):ThriveUlt.t.Choose_a_template},validate:function(a,b){return a.post_parent?a.post_type?void 0:ThriveUlt.t.DesignTypeMissing:ThriveUlt.t.InvalidCampaign},clearRefetchTimer:function(){clearTimeout(this.refetch_timeout)},initRefetchTimer:function(){function a(){b.get("thumb_url")||(b.fetch(),b.refetch_timeout=setTimeout(a,5e3))}var b=this;b.refetch_timeout=setTimeout(a,5e3)},getShortcode:function(){return"[tu_countdown id="+this.get("post_parent")+" design="+this.get("ID")+"][/tu_countdown]"}}),ThriveUlt.collections.Designs=ThriveUlt.collections.Base.extend({model:ThriveUlt.models.Design,campaign_id:0,set_campaign_id:function(a){return this.campaign_id=a,this},url:function(){return ThriveUlt.ajaxurl("action="+ThriveUlt.ajax_actions.admin_controller+"&route=designList&get_states=1&campaign_id="+this.campaign_id)},mark_selected_event_actions:function(a){return a&&a.length?(a.each(_.bind(function(a){var b=this.findWhere({ID:a.get("design")});if(b){b.set("event_display",!0);this._find_state(a.get("design"),a.get("state"))&&b.set("event_state",a.get("state"))}},this)),this):this},_find_state:function(a,b){var c=this.get(a);return a==b?c:c.get("children")?c.get("children").get(b):c}}),ThriveUlt.models.Event=ThriveUlt.models.Base.extend({initialize:function(a){this.get("actions")instanceof ThriveUlt.collections.EventActions||this.set("actions",new ThriveUlt.collections.EventActions(a.actions)),this.set("ID",a.id?a.id:"")},parse:function(a){return this.ensureCollectionData(a,{actions:ThriveUlt.collections.EventActions}),a},url:function(){var a=ajaxurl+"?action="+ThriveUlt.ajax_actions.admin_controller+"&route=events";return this.get("ID")&&(a+="&ID="+this.get("ID")),a},validate:function(a){if(!a.type||"start"!==a.type){if(!a.days&&!a.hours)return this.validation_error("time",ThriveUlt.t.InvalidTriggerTime);if(a.days<0||a.hours<0)return this.validation_error("time",ThriveUlt.t.InvalidTriggerTime)}},validateTrigger:function(a){if(this.get("type")===ThriveUlt.event_type.start)return null;var b=24*parseInt(a.get("days"))+parseInt(a.get("hours"));return parseInt(24*this.get("days")+parseInt(this.get("hours")))>=b?this.validation_error("time",ThriveUlt.t.InvalidEventTriggerTime):void 0},getDuration:function(){return 24*parseInt(this.get("days"))+parseInt(this.get("hours"))},setTime:function(a,b){"days"===b&&(this.set("days",a),this.set("hours",0)),"hours"===b&&(this.set("days",0),this.set("hours",a))},getLabel:function(){if(this.get("label")&&this.get("label").length)return this.get("label");if(0==this.get("hours"))return"-"+ThriveUlt.util.plural("%s "+ThriveUlt.t.Day,"%s "+ThriveUlt.t.Days,this.get("days"));if(0==this.get("days")){if(parseInt(this.get("hours"))>24){var a=parseInt(this.get("hours")/24);return"-"+ThriveUlt.util.plural("%s "+ThriveUlt.t.Day,"%s "+ThriveUlt.t.Days,a)+" and "+ThriveUlt.util.plural("%s "+ThriveUlt.t.Hour,"%s "+ThriveUlt.t.Hours,this.get("hours")-24*a)}return"-"+ThriveUlt.util.plural("%s "+ThriveUlt.t.Hour,"%s "+ThriveUlt.t.Hours,this.get("hours"))}return"-"+ThriveUlt.util.plural("%s "+ThriveUlt.t.Day,"%s "+ThriveUlt.t.Days,this.get("days"))+"<br/>"+ThriveUlt.util.plural("%s "+ThriveUlt.t.Hour,"%s "+ThriveUlt.t.Hours,this.get("hours"))},buildActionsFromDesigns:function(a){var b=new ThriveUlt.collections.EventActions;return a.each(function(a){if(!a.get("event_display"))return!0;b.add({design:a.get("ID"),state:a.get("event_state"),key:ThriveUlt.data.actions.design_show.key})}),this.set("actions",b),this}}),ThriveUlt.collections.Events=ThriveUlt.collections.Base.extend({model:ThriveUlt.models.Event,url:ThriveUlt.ajaxurl("action="+ThriveUlt.ajax_actions.admin_controller+"&route=events"),comparator:function(a){return-(parseInt(a.get("hours"))+24*a.get("days"))},removeEvents:function(a){this.each(function(b){if(b.get("type")!==ThriveUlt.event_type.end){var c=b.get("actions");c.filter(function(b){return b.get("design")==a.get("ID")}).forEach(function(a){void 0!==a&&c.remove(a)})}})}}),ThriveUlt.models.EventAction=ThriveUlt.models.Base.extend({validate:function(a){if(!a.key||"0"===a.key)return this.validation_error("action",ThriveUlt.t.SelectAction);if(!ThriveUlt.data.actions[a.key])return this.validation_error("action",ThriveUlt.t.InvalidAction);if(a.key===ThriveUlt.data.actions.design_show.key||a.key===ThriveUlt.data.actions.design_switch_state.key){var b=[];if(a.design&&"0"!==a.design||b.push(this.validation_error("design",ThriveUlt.t.SelectDesign)),a.state&&"0"!==a.state||b.push(this.validation_error("state",ThriveUlt.t.SelectState)),b.length)return b}return!ThriveUlt.data.actions.campaign_move||a.key!==ThriveUlt.data.actions.campaign_move.key||a.campaign&&"0"!==a.campaign?void 0:ThriveUlt.t.SelectCampaign},getFullName:function(){if("design_show"!==this.get("key"))return this.get("name");if(this.get("event_full_name"))return this.get("event_full_name");var a=ThriveUlt.globals.campaign.get("designs"),b=this.get("design"),c=a.get(b),d=this.get("state"),e=a._find_state(b,d),f="";return c&&e?(f=c.get("post_title"),f+=" ("+(b==d?ThriveUlt.t.main_state:e.get("post_title"))+")",f=ThriveUlt.util.printf(ThriveUlt.t.display_countdown_design,"<strong>"+f+"</strong>"),this.set("event_full_name",f),f):""}}),ThriveUlt.collections.EventActions=ThriveUlt.collections.Base.extend({model:ThriveUlt.models.EventAction}),ThriveUlt.models.BreadcrumbLink=ThriveUlt.models.Base.extend({defaults:{ID:"",hash:"",label:"",full_link:!1},initialize:function(a){this.get("ID")||this.set("ID",a.label.split(" ").join("").toLowerCase()),this.set("full_link",a.hash.match(/^http/))},get_url:function(){return this.get("full_link")?this.get("hash"):"#"+this.get("hash")}}),ThriveUlt.models.ConversionEvent=ThriveUlt.models.Event.extend({defaults:{ID:"",actions:[],trigger_options:{trigger:"",trigger_ids:"",event:""}},initialize:function(a){this.get("trigger_options")||this.set("trigger_options",a.trigger_options),this.set("ID",a.id?a.id:"")},parse:function(a){return a},validate:function(a,b){var c=a.trigger_options,d=[];return c.event&&0!==parseInt(c.event)||d.push(this.validation_error("action_event",ThriveUlt.t.Event_type_required)),d.length?d:c.event!==ThriveUlt.util.conversion_event.move||c.end_id?void 0:ThriveUlt.t.InvalidEndId},validateTrigger:function(){var a=this.get("trigger_options"),b=[];if(a.trigger&&0!==parseInt(a.trigger)||b.push(this.validation_error("trigger",ThriveUlt.t.Trigger_required)),b.length)return b;if(!a.trigger_ids){if(a.trigger===ThriveUlt.util.trigger_type.conversion)return ThriveUlt.t.Select_conversion_target;a.trigger===ThriveUlt.util.trigger_type.specific&&b.push(this.validation_error("conversion_page",ThriveUlt.t.Choose_conversion_page))}return b.length?b:void 0}}),ThriveUlt.collections.ConversionEvents=ThriveUlt.collections.Base.extend({model:ThriveUlt.models.ConversionEvent}),ThriveUlt.models.LinkedTo=ThriveUlt.models.Base.extend({}),ThriveUlt.collections.LinkedToCollection=ThriveUlt.collections.Base.extend({model:ThriveUlt.models.LinkedTo}),ThriveUlt.collections.Breadcrumbs=ThriveUlt.collections.Base.extend({model:ThriveUlt.models.Base.extend({defaults:{hash:"",label:""}}),add_page:function(a,b){var c=new ThriveUlt.models.BreadcrumbLink({hash:a,label:b});return this.add(c)}})}(jQuery);var ThriveUlt=ThriveUlt||{};ThriveUlt.views=ThriveUlt.views||{},function(a){a(function(){ThriveUlt.views.ModalSteps=TVE_Dash.views.Modal.extend({stepClass:".tvu-modal-step",currentStep:0,$step:null,events:{"click .tvu-modal-next-step":"next","click .tvu-modal-prev-step":"prev"},afterRender:function(){return this.steps=this.$el.find(this.stepClass).hide(),this.gotoStep(0),this},gotoStep:function(a){var b=this.steps.hide().eq(a).show(),c=this;return this.$step=b,
setTimeout(function(){c.input_focus(b)},50),this.currentStep=a,this},next:function(){this.beforeNext(),this.gotoStep(this.currentStep+1),this.afterNext()},prev:function(){this.beforePrev(),this.gotoStep(this.currentStep-1),this.afterPrev()},beforeNext:function(){return this},afterNext:function(){return this},beforePrev:function(){return this},afterPrev:function(){return this}}),ThriveUlt.views.ModalAddDesign=TVE_Dash.views.Modal.extend({template:TVE_Dash.tpl("modals/new-design"),type:"",events:{"click .tvu-save-new-design":"save","click div[data-type]":"select_type"},afterRender:function(){return this.$el.addClass("tvu-modal-design-type"),this.design_model=new ThriveUlt.models.Design({post_parent:this.model.get("ID"),post_type:this.type}),ThriveUlt.util.data_binder(this,this.design_model),this},select_type:function(b){var c=a(b.currentTarget),d=c.data("type"),e=c.children(".tvd-card"),f=this.$el.find(".tvu-campaign-selector").children(".tvd-card");ThriveUlt.select_card(e,f,"tvu-selected-design"),"shortcode"===d?(this.$("#tu-design-name-wrapper").show(),this.$("#tu-design-name").focus().select()):this.$("#tu-design-name-wrapper").hide(),this.design_model.set("post_type",d)},save:function(){if(this.design_model.isValid()){var a=this,b=this.design_model;TVE_Dash.showLoader();var c=b.save({wait:!0});c&&(c.done(function(c,d,e){b.set(c),b.set("ID",c.id),a.model.get("designs").add(b),a.model.trigger("tve_ult_campaign_saved"),b.initRefetchTimer(),TVE_Dash.hideLoader()}),c.error(function(a){TVE_Dash.hideLoader()}),c.always(function(){a.close()}))}}}),ThriveUlt.views.ModalEditCampaignType=TVE_Dash.views.Modal.extend({className:"tvd-modal-fixed-footer tvd-modal",template:TVE_Dash.tpl("modals/edit-campaign"),events:{"click .tvu-campaign-selector":"showCampaignOptions","click .tvu-save-campaign-type":"save"},afterInitialize:function(){this.listenTo(this.model,"change:type",this.renderSettings)},afterRender:function(){return this.$el.addClass("tvu-campaign-modal"),this.renderSettings(),this},renderSettings:function(){var a=this.model.get("type"),b=this.collection,c=null;if(a||this.model.set("edit_mode","new"),this.model.set("settings_modal","modal"),ThriveUlt.views["CampaignType"+ThriveUlt.util.upperFirst(a)+"State"])return a==ThriveUlt.util.campaignType.evergreen&&(!1===ThriveUlt.data.lead_groups?b=null:(b=new ThriveUlt.collections.LeadGroupsCollection(ThriveUlt.data.lead_groups),c=new ThriveUlt.collections.ShortcodesCollection(ThriveUlt.data.shortcodes))),this[a]?this[a].setElement(this.$("#tvu-campaign-type-options")[0]):this[a]=new(ThriveUlt.views["CampaignType"+ThriveUlt.util.upperFirst(a)+"State"])({el:this.$el.find("#tvu-campaign-type-options")[0],model:this.model,collection:b,shortcodes:c}),this[a].render(),this[a].$el.hide().fadeIn().slideDown(),this},save:function(){var a=this.collection.getIDsArray();if(this.model.get("rolling_type")||this.model.set("rolling_type","daily"),this.model.get("settings").repeatOn=a,this.tvd_clear_errors(),!this.model.isValid())return this.tvd_show_errors(this.model);var b=this;TVE_Dash.showLoader(),this.model.cleanModel(),this.model.save().done(function(){TVE_Dash.hideLoader(),b.model.getSummary(),b.model.unset("edit_mode"),b.model.unset("settings_modal");try{var a=ThriveUlt.globals.campaigns.findWhere({ID:b.model.get("ID")});a instanceof ThriveUlt.models.Campaign&&a.set(b.model.toJSON()),ThriveUlt.globals.campaign.set(b.model.toJSON())}catch(a){console.log("Error: "+a)}b.original_model.trigger("tve_ult_campaign_saved")}).error(function(){TVE_Dash.hideLoader()}).always(function(){b.close()})},showCampaignOptions:function(b){var c=b.currentTarget,d=a(c).attr("data-type"),e=a(c).children(".tvd-card"),f=this.$el.find(".tvd-card");ThriveUlt.select_card(e,f,"tvu-selected-design"),this.model.set("type",d)},onClose:function(){a(".tvd-material-tooltip").hide()}}),ThriveUlt.views.ModalEditDateSettings=TVE_Dash.views.Modal.extend({className:"tvd-modal-fixed-footer tvd-modal tvu-edit-date-settings-modal",template:TVE_Dash.tpl("modals/edit-date-settings"),events:{"change #tvu-date-format-setting":"changeDateFormat","change #tvu-time-format-setting":"changeTimeFormat","change #tvu-timezone-setting":"changeTimeZone","click .tvu-save-date-settings":"save"},afterOpen:function(){var a=this.model.get("offset");a&&this.$el.find('#tvu-timezone-setting option[value="'+a+'"]').attr("selected","selected")},changeDateFormat:function(a){this.model.set("date_format",a.target.value)},changeTimeFormat:function(a){this.model.set("time_format",a.target.value)},changeTimeZone:function(a){this.model.set("offset",a.target.value)},save:function(){if(this.tvd_clear_errors(),!this.model.isValid())return this.tvd_show_errors(this.model);var a=this;this.model.save().done(function(){TVE_Dash.hideLoader()}).error(function(){TVE_Dash.hideLoader()}).always(function(){a.close()})}}),ThriveUlt.views.ModalEditLockDownSettings=TVE_Dash.views.Modal.extend({className:"tvd-modal-fixed-footer tvd-modal",template:TVE_Dash.tpl("modals/edit-lockdown"),events:{"click .tvu-save-lockdown-settings":"save","click .tve_ult_add_promotion_field":function(){this.addPromotionField()},"click .tve-ult-remove-button":"removePromotionField","change #tvu-autoresponder-type":"generateAllEmailLinks"},afterInitialize:function(){this.listenTo(this.collection,"add",function(a){this.renderOnePromotion(a),this.renderOneLink(a)}),this.listenTo(this.collection,"remove",this.renderPromotionUrls)},afterOpen:function(){TVE_Dash.bindZClip(this.$el.find("a.tve-copy-to-clipboard"))},afterRender:function(){function b(){var b=a(this);f.get("lockdown_settings")[b.data("field")]=null}function c(){var b=a(this);f.get("lockdown_settings")[b.data("field")]={value:b.val()},"promotion"===b.data("field")&&e.$("#tvu-autoresponder-type").change()}function d(b,c){var d=a(this);f.get("lockdown_settings")[d.data("field")]=c.item,"promotion"===d.data("field")&&e.$("#tvu-autoresponder-type").change()}this.renderPromotionUrls();var e=this,f=this.model,g=this.$("#tvu-lockdown-pre-access-url"),h=this.$("#tvu-lockdown-expired-url"),i=this.$("#tvu-autoresponder-type");this.$el.addClass("tvu-lockdown-modal"),f.set("lockdown",!0);var j={url:ThriveUlt.ajaxurl("action="+ThriveUlt.ajax_actions.admin_controller+"&route=progressiveGetPosts"),no_value_callback:b,change_callback:c,select:d};return new ThriveUlt.PostSearch(g,j),new ThriveUlt.PostSearch(h,j),this.collection.length>0&&i.find('option[value="'+f.get("lockdown_settings").service+'"]').attr("selected","seletced").select2(),this},generateAllEmailLinks:function(b){var c=this.collection,d=a("option:selected",b.target).attr("data-tag"),e=this.$el;return c.each(function(a){if(a.get("link")){var b=a.get("link").split("tu_em=")[0],f=c.indexOf(a),g=b+"tu_em="+d;e.find("#tvu-email-link"+f).val(g),a.set("link",g,{silent:!0})}},this),this.model.get("lockdown_settings").service=b.target.value,this},save:function(){this.tvd_clear_errors();var a=this,b=a.collection.cleanCollection();return this.model.get("lockdown_settings").promotion=a.collection,this.model.isValid()?0===!Object.keys(b).length?this.tvd_show_errors(this.model):(TVE_Dash.showLoader(),void this.model.save().done(function(){TVE_Dash.hideLoader();try{var b=ThriveUlt.globals.campaigns.findWhere({ID:a.model.get("ID")});b instanceof ThriveUlt.models.Campaign&&b.set(a.model.toJSON()),ThriveUlt.globals.campaign.set(a.model.toJSON())}catch(a){console.log("Error: "+a)}a.original_model.trigger("tve_ult_campaign_saved")}).error(function(){TVE_Dash.hideLoader()}).always(function(){a.close()})):this.tvd_show_errors(this.model)},addPromotionField:function(){var a=new ThriveUlt.models.PromotionURLModel;this.collection.add(a),ZeroClipboard.Client.prototype.destroy(),this.$el.find(".zclip").remove(),TVE_Dash.bindZClip(this.$el.find("a.tve-copy-to-clipboard"))},removePromotionField:function(b){var c=a(b.target).closest(".tvd-input-field"),d=c.find(".tvu-promotion-url"),e=parseInt(d.prop("id").match(/\d+/g),10);this.collection.remove(this.collection.at(e))},renderPromotionUrls:function(){var a=this.collection;this.$el.find(".tve-ult-promotion-wrapper").empty(),this.$el.find(".tvu-url-to-copy-wrapper").empty(),a.each(this.renderOnePromotion,this),a.each(this.renderOneLink,this)},renderOnePromotion:function(a){var b=new ThriveUlt.views.LockdownPromotionURL({model:a,collection:this.collection,parent_model:this.model});this.$el.find(".tve-ult-promotion-wrapper").append(b.render().$el)},renderOneLink:function(a){var b=new ThriveUlt.views.LockdownServiceURL({model:a,collection:this.collection});this.$el.find(".tvu-url-to-copy-wrapper").append(b.render().$el)}}),ThriveUlt.views.ModalEditEvent=TVE_Dash.views.Modal.extend({template:TVE_Dash.tpl("modals/edit-event"),className:"tvd-modal tvd-modal-fixed-footer",events:function(){return _.extend({},ThriveUlt.views.ModalSteps.prototype.events,{"change #tvu-event-time":"setTime","change #tvu-event-unit":"setTime","click .tvu-event-save":"saveEvent"})},renderDesignItems:function(){var a=this.$("#tvu-event-designs");this.designs.each(function(b){a.append(new ThriveUlt.views.EventModalDesignItem({model:b}).render().$el)})},afterRender:function(){this.renderDesignItems(),this.$el.addClass("tvu-add-timeline-event-modal"),this.steps=this.$el.find(this.stepClass).hide(),this.$actionsList=this.$el.find("#tvu-event-actions-list"),this.$triggerOptions=this.$el.find("#tvu-trigger-options"),this.model.get("type")!==ThriveUlt.event_type.start&&this.$triggerOptions.show();var a=parseInt(this.model.get("days"));return void 0!==this.model.get("hours")&&0!=this.model.get("hours")&&(this.$el.find("#tvu-event-unit").val("hours"),TVE_Dash.materialize(this.$el),a=24*parseInt(this.model.get("days"))+parseInt(this.model.get("hours"))),isNaN(a)||this.$el.find("#tvu-event-time").val(a),this},saveEvent:function(){if(this.tvd_clear_errors(),this.model.buildActionsFromDesigns(this.designs),!this.model.isValid())return this.tvd_show_errors();var a=this.model.validateTrigger(this.collection.findWhere({type:"start"}));if(a)return this.tvd_show_errors(a);TVE_Dash.showLoader();var b=this;this.model.save({},{success:function(a,c){if(TVE_Dash.hideLoader(),b.close(),a.get("ID")){var d=b.model.getDuration()===b.original_model.getDuration()?"edited":"duration_changed",e=b.collection.indexOf(b.original_model);b.model.set("label",null),b.original_model.set(a.attributes),b.original_model.set("status",d),b.collection.sort(),e===b.collection.indexOf(b.original_model)&&b.original_model.unset("status"),b.collection.trigger("update")}else a.set("ID",c.id),a.set("status","new"),b.collection.add(a)},error:function(a,b){TVE_Dash.err(b.responseText),TVE_Dash.hideLoader()}})},setTime:function(b){var c=a(b.currentTarget);c.is("input")?this.model.setTime(parseInt(c.val()),this.$el.find("#tvu-event-unit").val()):this.model.setTime(parseInt(this.$el.find("#tvu-event-time").val()),c.val())}}),ThriveUlt.views.ModalCopyCampaign=ThriveUlt.views.ModalSteps.extend({template:TVE_Dash.tpl("modals/copy-campaign"),events:{"click .tvd-modal-submit":"save"},afterRender:function(){return this.$el.addClass("tvu-campaign-modal"),this.renderSettings(),this},renderSettings:function(){var a=this.model.get("type");if(this.settings_collection=new ThriveUlt.collections.RollingCollection,a||this.model.set("edit_mode","new"),this.model.set("settings_modal","modal"),ThriveUlt.views["CampaignType"+ThriveUlt.util.upperFirst(a)+"State"]){a==ThriveUlt.util.campaignType.evergreen&&(!1===ThriveUlt.data.lead_groups?this.settings_collection=null:(this.settings_collection=new ThriveUlt.collections.LeadGroupsCollection(ThriveUlt.data.lead_groups),this.shortcodes=new ThriveUlt.collections.ShortcodesCollection(ThriveUlt.data.shortcodes)));new(ThriveUlt.views["CampaignType"+ThriveUlt.util.upperFirst(a)+"State"])({el:this.$el.find("#tvu-campaign-type-options"),model:this.model,collection:this.settings_collection,shortcodes:this.shortcodes}).render()}},save:function(){if(this.model.get("type")==ThriveUlt.util.campaignType.rolling){var a=this.settings_collection.getIDsArray();this.model.get("rolling_type")||this.model.set("rolling_type","daily"),this.model.get("settings").repeatOn=a}if(this.tvd_clear_errors(),!this.model.isValid())return this.tvd_show_errors(this.model);var b=this;TVE_Dash.showLoader(),this.model.cleanModel(),this.model.save().done(function(a){b.model.set("ID",a),b.model.set("post_title",ThriveUlt.t.Copy_of+b.model.get("post_title")),b.model.set("status",ThriveUlt.util.status.paused),b.model.set("chart_data",""),b.collection.add(b.model,{at:b.collection.length}),TVE_Dash.hideLoader()}).error(function(){TVE_Dash.hideLoader()}).always(function(){b.close()})}}),ThriveUlt.views.ModalNewCampaign=ThriveUlt.views.ModalSteps.extend({template:TVE_Dash.tpl("modals/new-campaign"),events:function(){return _.extend({},ThriveUlt.views.ModalSteps.prototype.events,{"click .tvu-new-campaign-tpl":function(b){var c=a(b.target).parents(),d=this.$el.find(".tvu-new-campaign-tpl").parents();ThriveUlt.select_card(c,d,"tvu-selected-design"),this.model.set("tpl",b.target.dataset.id),this.renderDescription()},"click .tvd-modal-submit":"save"})},afterInitialize:function(){this.listenTo(this.model,"change:tpl",_.bind(function(){var a=this.data.templates.findWhere({id:this.model.get("tpl")});this.model.set("post_title",a.get("is_empty")?"":a.get("name"))},this))},afterRender:function(){return this.steps=this.$el.find(this.stepClass).hide(),this.gotoStep(0),this.renderTemplates(),this.renderDescription(),ThriveUlt.util.data_binder(this),this},renderTemplates:function(){var a=this.$el.find(".tvu-new-campaign-templates");return a.empty(),this.data.templates.each(function(b,c){a.append(TVE_Dash.tpl("modals/new-campaign-tpl",{item:b,index:c+1}))},this),this},renderDescription:function(){var a=this.$el.find(".tvu-new-campaign-description"),b=this.model.get("tpl");if(b){var c=this.data.templates.at(b);a.empty().append("<span>"+c.get("description")+"</span>")}},next:function(){if(!this.model.get("tpl"))return TVE_Dash.err(ThriveUlt.t.CampaignMissingTemplate);this.gotoStep(this.currentStep+1)},save:function(){if(this.model.set("skip_settings_validation",!0),this.model.isValid()){var a=this;TVE_Dash.showLoader(),this.model.set("template_values",!0),this.model.save().done(function(b){a.model.set("ID",b),a.collection.add(a.model,{at:a.collection.length}),ThriveUlt.globals.campaigns.add(a.model,{at:a.collection.length}),a.close(),ThriveUlt.router.navigate("#dashboard/campaign/"+b,{trigger:!0})}).error(function(){TVE_Dash.hideLoader()}).always(function(){TVE_Dash.showLoader()})}}}),ThriveUlt.views.ModalConversionEvent=ThriveUlt.views.ModalSteps.extend({template:TVE_Dash.tpl("modals/new-conversion-event"),events:function(){return _.extend({},ThriveUlt.views.ModalSteps.prototype.events,{"change #tvu-select-campaign-trigger":"changeTriggers","change #tvu-select-campaign-event":"changeEvents","click #tvu-add-evergreen-campaign":"addEvergreenCampaign","click .tvu-continue-events":"showEvents","click .tvu-save-new-evergreen-campaign":"createEvergreenCampaign","click #tvu-new-campaign-repeat-campaign-switch":"toggleEndCampaign","click .tvu-save-new-conversion-event":"save"})},afterInitialize:function(){this.listenTo(ThriveUlt.globals.campaigns,"add",this.renderEvents)},afterRender:function(){return this.$el.addClass("tvu-conversion-event-modal"),this.renderTriggers(),this.renderEvents(),this.renderSummary(),this.steps=this.$el.find(this.stepClass).hide(),this.gotoStep(0),TVE_Dash.materialize(this.$el),this.$el.find("select").select2().each(function(){var b=a(this);b.on("select2:open",function(){b.data("select2").$dropdown.addClass("tvu-conversion-event-select")})}),this},renderSummary:function(){new ThriveUlt.views.ConversionSummary({el:this.$el.find("#tvu-trigger-description"),model:this.model}).render()},renderTriggers:function(){var a=this.model.get("trigger_options").trigger,b=new ThriveUlt.collections.LeadGroupsCollection,c=new ThriveUlt.collections.ShortcodesCollection;if(ThriveUlt.data.lead_groups&&b.reset(ThriveUlt.data.lead_groups),ThriveUlt.data.shortcodes&&c.reset(ThriveUlt.data.shortcodes),a&&0!==parseInt(a)){var d=new(ThriveUlt.views["TriggerType"+ThriveUlt.util.upperFirst(a)])({el:this.$el.find("#tvu-conversion-triggers"),model:this.model,collection:b,shortcodes:c});d.render(),d.$el.hide().fadeIn().slideDown()}},renderEvents:function(){var a=this.model.get("trigger_options").event,b=new ThriveUlt.collections.Campaigns(ThriveUlt.globals.campaigns.where({type:ThriveUlt.util.campaignType.evergreen}));if(b.length>0){var c=b.findWhere({ID:parseInt(this.model.get("campaign_id"))});b.remove(c)}if(a&&0!==parseInt(a)){var a=new(ThriveUlt.views["EventType"+ThriveUlt.util.upperFirst(a)])({el:this.$el.find("#tvu-conversion-events"),model:this.model,collection:b});a.render(),a.$el.hide().fadeIn().slideDown()}},changeTriggers:function(a){this.model.get("trigger_options").trigger=a.target.value,this.renderTriggers(),this.renderEvents(),this.renderSummary()},changeEvents:function(a){this.model.get("trigger_options").event=a.target.value,this.renderTriggers(),this.renderEvents(),this.renderSummary(),this.gotoStep(1)},save:function(){var a=this;if(this.model.get("trigger_options").event===ThriveUlt.util.conversion_event.end&&(this.model.get("trigger_options").end_id=""),!this.model.isValid())return this.tvd_show_errors();TVE_Dash.showLoader(),this.model.save({},{success:function(b,c){a.model.get("ID")?a.original_model.set(b.attributes):(a.model.set("ID",c.id),a.collection.add(a.model)),a.close(),TVE_Dash.hideLoader()},error:function(a,b){TVE_Dash.err(b.responseText),TVE_Dash.hideLoader()}})},showEvents:function(){var a=this.model.validateTrigger();if(a)return this.tvd_show_errors(a);this.next()},addEvergreenCampaign:function(){this.next()},toggleEndCampaign:function(){this.$el.find(".tvu-repeat-wrapper").toggle()},createEvergreenCampaign:function(){var a=new ThriveUlt.models.Campaign({order:ThriveUlt.globals.campaigns.length}),b=this,c=this.$el.find("#tvu-new-campaign-name").val(),d=this.$el.find("#tvu-new-campaign-days").val(),e=this.$el.find("#tvu-new-campaign-expire").val(),f=this.$el.find(".tvu-new-campaign-repeat-switch"),g="";f.is(":checked")?g=0:(g=1,e="");var h={duration:d,end:e,repeat:g,real:1,realtime:"00:00",trigger:{type:"",ids:""}};if(a.set({post_title:c,type:ThriveUlt.util.campaignType.evergreen,tpl:1,edit_mode:"evergreen",settings:h}),a.cleanModel(),this.tvd_clear_errors(),!a.isValid())return this.tvd_show_errors(a);TVE_Dash.showLoader(),a.save({},{success:function(c,d){var e=b.model.get("trigger_options").end_id;a.set("ID",d),b.model.get("ID")&&(b.model.get("trigger_options").end_id_old=e),b.model.get("trigger_options").end_id=d,ThriveUlt.globals.campaigns.add(a),TVE_Dash.hideLoader(),b.gotoStep(1)},error:function(a,b){TVE_Dash.err(b.responseText),TVE_Dash.hideLoader()}})}}),ThriveUlt.views.ModalShortcodeCode=TVE_Dash.views.Modal.extend({template:TVE_Dash.tpl("modals/get-shortcode"),afterOpen:function(){TVE_Dash.bindZClip(this.$el.find("a.tve-copy-to-clipboard"))}})})}(jQuery);var ThriveUlt=ThriveUlt||{};ThriveUlt.views=ThriveUlt.views||{},function(a){function b(b){if(b.model.has("display_settings"))return ThriveUlt.objects.hangers=b.model.get("display_settings"),ThriveUlt.objects.savedTemplates=b.model.get("display_settings_tpl"),void TVE_Dash.modal(ThriveUlt.views.CampaignSettings,{model:b.model,"max-width":"90%",width:"80%",collection:b.model.get("display_settings")});TVE_Dash.showLoader(),a.ajax({url:b.model.getDisplaySettingsUrl(),data:{_nonce:ThriveUlt.admin_nonce},dataType:"json"}).done(function(a){ThriveUlt.objects.savedTemplates=new ThriveUlt.models.TemplateList(a.savedTemplates),ThriveUlt.objects.hangers=new ThriveUlt.collections.Hangers(a.hangers),TVE_Dash.modal(ThriveUlt.views.CampaignSettings,{model:b.model,"max-width":"90%",width:"80%",collection:ThriveUlt.objects.hangers})}).fail(function(a){console.error&&console.error(arguments)}).always(function(){setTimeout(function(){TVE_Dash.hideLoader()},300)})}a(function(){Backbone.View.prototype.tvd_clear_errors=function(){return this.$(".tvd-invalid").removeClass("tvd-invalid"),this.$("select").trigger("tvdclear"),this},Backbone.View.prototype.tvd_show_errors=function(b){function c(b){if("string"==typeof b)return TVE_Dash.err(b);f=f.add(e.$("[data-field="+b.field+"]").addClass("tvd-invalid").each(function(){var c=a(this);c.is("select")?c.trigger("tvderror",b.message):c.next("label").attr("data-error",b.message)}))}if(b=b||this.model){var d=b instanceof Backbone.Model?b.validationError:b,e=this,f=a();return a.isArray(d)?_.each(d,function(a){c(a)}):c(d),f.not(".tvd-no-focus").first().focus(),this.scroll_first_error(f.first()),this}},Backbone.View.prototype.scroll_first_error=function(a){if(!(this instanceof TVE_Dash.views.Modal&&a.length))return this;var b=a.offset().top,c=this.$_content.offset().top,d=this.$_content.scrollTop(),e=this.$_content.outerHeight();if(b>=c&&b<e+c-50)return this;this.$_content.animate({scrollTop:d+b-c-40},200,"swing")},ThriveUlt.views.Base=Backbone.View.extend({render:function(){return this},modal:function(a,b){return TVE_Dash.modal(a,b)}}),ThriveUlt.views.Header=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("header"),events:{"click #date_time_settings":"openSettingsModal"},render:function(){return this.$el.html(this.template({})),TVE_Dash.materialize(this.$el),this},openSettingsModal:function(){this.modal(ThriveUlt.views.ModalEditDateSettings,{model:this.model,width:"1200px","max-width":"80%"})}}),ThriveUlt.views.Dashboard=ThriveUlt.views.Base.extend({className:"tvd-container",template:TVE_Dash.tpl("dashboard"),initialize:function(){this.listenTo(this.collection,"add",this.toggleNoCampaignText),this.listenTo(this.collection,"remove",this.toggleNoCampaignText)},render:function(){return this.$el.html(this.template({})),new ThriveUlt.views.CampaignsList({el:this.$el.find("#tvu-campaigns-list"),collection:this.collection}).render(),this.toggleNoCampaignText(),TVE_Dash.hideLoader(),this},toggleNoCampaignText:function(){this.collection.length?this.$el.find("#tvu-no-campaign-text").hide():this.$el.find("#tvu-no-campaign-text").show()}}),ThriveUlt.views.ArchivedCampaigns=ThriveUlt.views.Dashboard.extend({template:TVE_Dash.tpl("campaign/archived")}),ThriveUlt.views.CampaignsList=ThriveUlt.views.Base.extend({events:{"click .tvu-add-campaign":"addNew"},initialize:function(){this.listenTo(this.collection,"add",this.renderOne)},itemViews:[],render:function(){function b(b,c){var d=a(c.placeholder),e=d.prevAll().not(c.item).length+1;d.html("<div class='tvu-inside-placeholder'><span>"+e+(ThriveUlt.t.n_suffix[e]?ThriveUlt.t.n_suffix[e]:ThriveUlt.t.n_th)+" "+ThriveUlt.t.priority+"</span></div>")}this.collection.each(this.renderOne,this);var c=this;return this.$el.sortable({placeholder:"ui-sortable-placeholder",items:".tvu-campaign-item",forcePlaceholderSize:!0,handle:".tvu-drag-card",update:_.bind(c.updateOrder,this),tolerance:"pointer",change:b,start:function(c,d){b(c,d),a("body").addClass("tvu-sorting")},stop:function(){setTimeout(function(){a("body").removeClass("tvu-sorting")},200)}}),this},renderOne:function(a){var b=this.$el.find(".tvu-campaign-item").last(),c=new ThriveUlt.views.Campaign({model:a,collection:this.collection});return b.length?b.after(c.render().$el):this.$el.prepend(c.render().$el),this.itemViews.push(c),this},updateOrder:function(){var b={};_.each(this.itemViews,function(a){a.model.get("order")!=a.$el.index()&&(a.model.set("order",a.$el.index()),b[a.model.get("ID")]=a.$el.index())}),this.collection.sort(),a.ajax({type:"post",url:ajaxurl,data:{action:ThriveUlt.ajax_actions.admin_controller,route:"campaigns",custom:"update_order",new_order:b,_nonce:ThriveUlt.admin_nonce}})},addNew:function(){return this.modal(ThriveUlt.views.ModalNewCampaign,{model:new ThriveUlt.models.Campaign({order:this.collection.length}),collection:this.collection,"max-width":"60%",width:"750px",in_duration:200,out_duration:0,templates:new Backbone.Collection(ThriveUlt.campaign_templates)}),this}}),ThriveUlt.views.Campaign=ThriveUlt.views.Base.extend({events:{"click .tvu-campaign-status":"changeStatus","click .tvu-archive-campaign":"toggle_archive"},initialize:function(){this.listenTo(this.model,"change:state",this.renderState),this.listenTo(this.model,"change:status",this.renderStatus)},render:function(){return this.renderState(),this},renderState:function(){var a=this.model.get("state");if(this.model.get("status")===ThriveUlt.util.status.archived&&(a=ThriveUlt.util.status.archived),ThriveUlt.views["Campaign"+ThriveUlt.util.upperFirst(a)+"State"]){var b=new(ThriveUlt.views["Campaign"+ThriveUlt.util.upperFirst(a)+"State"])({model:this.model,collection:this.collection});return b.render(),this.$el.replaceWith(b.$el),this.setElement(b.$el),this}},changeStatus:function(){var a,b,c=this.model.get("status");switch(c){case ThriveUlt.util.status.paused:a=ThriveUlt.util.status.running,b=ThriveUlt.t.Campaign_started;break;case ThriveUlt.util.status.running:a=ThriveUlt.util.status.paused,b=ThriveUlt.t.Campaign_paused;break;default:return}TVE_Dash.showLoader(),this.model.saveStatus(a).done(function(c){a===ThriveUlt.util.status.paused?TVE_Dash.err(b):TVE_Dash.success(b),TVE_Dash.hideLoader()}).fail(function(a){TVE_Dash.err(a.responseText),TVE_Dash.hideLoader()})},renderStatus:function(){""!=this.model.get("status")&&(this.$(".tvu-campaign-status").addClass("tvd-hide"),this.$(".tvu-campaign-status-"+this.model.get("status")).removeClass("tvd-hide"))},toggle_archive:function(b){var c=this,d=a(b.currentTarget),e=d.data(),f=!1===e.archived?ThriveUlt.util.status.archived:ThriveUlt.util.status.paused,g=this.model.get("post_title"),h=!1===e.archived?ThriveUlt.util.printf(ThriveUlt.t.campaign_archived,[g]):ThriveUlt.util.printf(ThriveUlt.t.campaign_restored,[g]);TVE_Dash.showLoader(),this.model.saveStatus(f).done(function(){c.collection.remove(c.model),c.remove(),TVE_Dash.success(h),TVE_Dash.hideLoader()}).fail(function(a){TVE_Dash.err(a.responseText),TVE_Dash.hideLoader()})}}),ThriveUlt.views.CampaignNormalState=ThriveUlt.views.Base.extend({className:"tvd-col tvd-s6 tvd-ms6 tvd-m4 tvd-l3 tvu-campaign-item",template:TVE_Dash.tpl("campaign/item"),events:{"click .tvu-delete-campaign":function(){this.$el.live_tooltip("destroy");var a=this.collection.findWhere({state:"delete"});a&&a.set("state",ThriveUlt.util.states.normal),this.model.set("state",ThriveUlt.util.states.delete)},"click .tvu-copy-campaign":"copy","click .tvu-campaign-display":"openDisplaySettings","click .tvu-edit-campaign-title":"editTitle"},render:function(){return this.$el.html(this.template({item:this.model})),this.$campaignTitle=this.$el.find(".tvd-card-title"),this.model.load_chart_data(_.bind(this.chart,this)),this},copy:function(){var a=this,b=this.model.deepClone();b.set("copy",b.get("ID")),b.set("ID","",{silent:!0}),b.set("order",a.collection.length,{silent:!0}),b.set("impressions",0),b.set("conversion_rate",0),b.set("conversion_events",""),b.set("has_event_logs",!1),this.modal(ThriveUlt.views.ModalCopyCampaign,{model:b,collection:this.collection,"max-width":"60%",width:"800px"})},editTitle:function(){var a=this,b=this.$el.find(".tvu-edit-campaign-title"),c=new Backbone.Model({value:this.model.get("post_title"),label:ThriveUlt.t.Campaign_name,required:!0});b.hide(),c.on("change:value",function(){a.saveTitle.apply(a,arguments),a.$campaignTitle.show(),d.remove(),b.show()}),c.on("tvu_no_change",function(){a.$campaignTitle.html(a.model.get("post_title")).show(),d.remove(),b.show()});var d=new ThriveUlt.views.TextEdit({model:c,tagName:"div"});this.$campaignTitle.hide().after(d.render().$el),d.focus()},saveTitle:function(a,b){var c=this;this.model.set({post_title:b,skip_settings_validation:!0}),c.$campaignTitle.html(b);var d=this.model.save();d&&d.always(function(){c.$campaignTitle.html(b),c.model.set("skip_settings_validation",!1)})},openDisplaySettings:function(){b(this)},chart:function(a){var b=!0,c=this.$(".tvu-chart-no-data").clone();(!a||a.impressions.length<2)&&(b=!1,a=this.model.get_chart_dummy_data());var d=[{title:{text:ThriveUlt.t.No_of_impressions}}],e=[{name:ThriveUlt.t.Impressions,type:"line",data:a.impressions}];a.conversions&&(d.push({labels:{format:"{value}"},title:{text:ThriveUlt.t.No_of_conversions},opposite:!0}),e.push({name:ThriveUlt.t.Conversions,type:"line",yAxis:1,data:a.conversions,tooltip:{valueSuffix:""}})),setTimeout(_.bind(function(){this.$(".tvu-campaign-chart").highcharts({colors:b?["#3498db","#47bb28"]:["#fff","#fff"],credits:{enabled:!1},plotOptions:{line:{marker:{enabled:!1}}},title:{text:" "},xAxis:{categories:a.labels,labels:{enabled:!1}},yAxis:d,tooltip:{shared:!0},legend:{enabled:!1},series:e}),b||this.$(".tvu-campaign-chart").addClass("tvd-relative tvu-blurred").append(c.removeClass("tvd-hide"))},this))}}),ThriveUlt.views.CampaignArchivedState=ThriveUlt.views.CampaignNormalState.extend({template:TVE_Dash.tpl("campaign/archived-item")}),ThriveUlt.views.CampaignDeleteState=ThriveUlt.views.Base.extend({className:"tvd-col tvd-s6 tvd-m4 tvd-ms6 tvd-l3 tvu-campaign-item",template:TVE_Dash.tpl("campaign/delete-state"),events:{"click .tvu-delete-no":function(){this.model.set("state",ThriveUlt.util.states.normal)},"click .tvu-delete-yes":"yes",keydown:"keyAction"},initialize:function(){this.listenTo(this.collection,"remove",this.remove)},render:function(){this.$el.html(this.template({item:this.model}));var a=this;return _.defer(function(){a.$(".tve-delete-campaign-card").focus()}),this},keyAction:function(a){var b=a.which;13==b?this.yes():27==b&&this.model.set("state",ThriveUlt.util.states.normal)},yes:function(){TVE_Dash.cardLoader(this.$el),this.model.destroy({wait:!0,success:function(){TVE_Dash.hideLoader()},error:function(){TVE_Dash.hideLoader()}})}}),ThriveUlt.views.EditCampaign=ThriveUlt.views.Base.extend({className:"tvd-container",template:TVE_Dash.tpl("campaign/edit"),timeline_view:null,conversion_view:null,events:{"click .tvu-add-design":"addDesign","click .tvu-edit-campaign-title":"editTitle","click .tvu-campaign-status":"changeStatus","click .tvu-edit-campaign":"editCampaignType","click .tvu-display-settings":"openDisplaySettings","click .tvu-lockdown":"openLockdownSettings","click .tvu-disable-lockdown":"disableLockdown"},initialize:function(){this.listenTo(this.model.get("designs"),"add",this.render),this.listenTo(this.model.get("designs"),"remove",this.render),this.listenTo(this.model.get("designs"),"remove",this.removeEventActions),this.listenTo(this.model,"change:summary",this.changeSettings),this.listenTo(this.model,"change:type",this.render),this.listenTo(this.model,"change:lockdown_state",this.renderLockdown),this.listenTo(this.model,"change:lockdown",this.render),this.listenTo(this.model,"change:status",this.renderStatus),this.listenTo(this.model,"change:display_settings_summary",this.render),this.listenTo(this.model,"tve_ult_campaign_saved",this.onCampaignSaved),this.listenTo(this.model.get("timeline"),"reset",this.renderTimeline)},onCampaignSaved:function(){this.fetchEvents(),this.render()},render:function(){this.$el.html(this.template({item:this.model})),this.$designList=this.$el.find("#tvu-designs-list"),this.$campaignTitle=this.$el.find(".tvu-campaign-title"),this.$campaignStatus=this.$el.find(".tvu-campaign-status");var a=this.model.get("status"),b=this.model;return ThriveUlt.data.shortcodes&&ThriveUlt.data.lead_groups||this.model.get("settings").trigger.type===ThriveUlt.util.triggerType.conversion&&a===ThriveUlt.util.status.running&&(a=ThriveUlt.util.status.paused,this.model.saveStatus(a).done(function(a){b.set("status",ThriveUlt.util.status.paused),TVE_Dash.err(ThriveUlt.t.leads_missing_paused,6e3)}).fail(function(a){TVE_Dash.err(a.responseText,6e3)})),a||(a=ThriveUlt.util.status.paused),this.$campaignStatus.html(a),this.changeSettings(),this.model.get("designs").each(_.bind(this.renderDesign,this)),this.renderTimeline(),this.renderConversionEvents(),this.renderLockdown(),
""==this.model.get("status")&&this.model.set("status",ThriveUlt.util.status.paused),TVE_Dash.materialize(this.$el),this},renderDesign:function(a){if(this.$designList.length){var b=this.$designList.find(".tvu-design-item").last(),c=new ThriveUlt.views.Design({model:a,collection:this.model.get("designs")});return c.render(),b.length?b.after(c.$el):this.$designList.prepend(c.$el),this}},addDesign:function(){this.modal(ThriveUlt.views.ModalAddDesign,{model:this.model,"max-width":"50%"})},openDisplaySettings:function(){b(this)},renderLockdown:function(){var a=this.model.get("lockdown_state");a||(a=this.model.set("lockdown_state",ThriveUlt.util.states.normal)),new(ThriveUlt.views["Lockdown"+ThriveUlt.util.upperFirst(a)+"State"])({model:this.model,el:this.$el.find("#tvd-lockdown-wrapper")[0]}).render()},openLockdownSettings:function(){if(!this.model.has_valid_lockdown_trigger())return!1;var b=new ThriveUlt.models.Campaign(a.extend(!0,{},this.model.toJSON())),c=new ThriveUlt.collections.PromotionURLCollection;this.model.get("lockdown_settings").promotion.each(function(a){c.add(new ThriveUlt.models.PromotionURLModel(a.toJSON()))}),this.modal(ThriveUlt.views.ModalEditLockDownSettings,{model:b,collection:c,original_model:this.model,original_collection:this.model.get("lockdown_settings").promotion,width:"800px","max-width":"60%"})},disableLockdown:function(){this.model.set("lockdown_state",ThriveUlt.util.states.delete)},editCampaignType:function(){var b=new ThriveUlt.models.Campaign(a.extend(!0,{},this.model.toJSON()));this.modal(ThriveUlt.views.ModalEditCampaignType,{model:b,original_model:this.model,collection:this.model.get("settings_collection"),width:"800px","max-width":"60%"})},changeStatus:function(){var a,b,c=this.model.get("status");switch(c){case ThriveUlt.util.status.paused:a=ThriveUlt.util.status.running,b=ThriveUlt.t.Campaign_started;break;case ThriveUlt.util.status.running:a=ThriveUlt.util.status.paused,b=ThriveUlt.t.Campaign_paused;break;default:return}TVE_Dash.showLoader(),this.model.saveStatus(a).done(function(c){a===ThriveUlt.util.status.paused?TVE_Dash.err(b):TVE_Dash.success(b),TVE_Dash.hideLoader()}).fail(function(a){TVE_Dash.err(a.responseText),TVE_Dash.hideLoader()})},renderStatus:function(){try{var a=ThriveUlt.globals.campaigns.findWhere({ID:this.model.get("ID")});a instanceof ThriveUlt.models.Campaign&&a.set("status",this.model.get("status"))}catch(a){console.log("Error: "+a)}this.render()},editTitle:function(){var a=this,b=this.$el.find(".tvu-edit-campaign-title"),c=new Backbone.Model({value:this.model.get("post_title"),label:ThriveUlt.t.Campaign_name,required:!0});b.hide(),c.on("change:value",function(){a.saveTitle.apply(a,arguments),a.$campaignTitle.show(),d.remove(),b.show()}),c.on("tvu_no_change",function(){a.$campaignTitle.html(a.model.get("post_title")).show(),d.remove(),b.show()});var d=new ThriveUlt.views.TextEdit({model:c,tagName:"div"});this.$campaignTitle.hide().after(d.render().$el),d.focus()},saveTitle:function(a,b){var c=this;try{var d=ThriveUlt.globals.campaigns.findWhere({ID:this.model.get("ID")});d instanceof ThriveUlt.models.Campaign&&d.set("post_title",b)}catch(a){console.log("Error: "+a)}this.model.set({post_title:b,skip_settings_validation:!0}),c.$campaignTitle.html(b);var e=this.model.save();e&&e.always(function(){c.$campaignTitle.html(b),c.model.set("skip_settings_validation",!1)})},changeSettings:function(){var a=this.model.get("summary"),b=this.model.get("type");b&&(this.updateDashboardCampaignType(),this.$el.find(".tvu-campaign-type-title").text(ThriveUlt.util.get_type_title(b)),this.$el.find(".tvu-campaign-icon").html('<img width="55" src="'+ThriveUlt.plugin_url+"admin/img/tvd-"+b+'-campaign.png"/>'),a?this.$el.find(".tvu-campaign-type").text(a):this.model.getSummary())},displaySettingsChanged:function(){this.$el.find("#tvu-display-summary").html(this.model.get("display_settings_summary"))},removeEventActions:function(a){this.model.get("timeline").removeEvents(a),this.renderTimeline()},renderTimeline:function(){this.timeline_view?this.timeline_view.setElement(this.$("#tvu-timeline-wrapper")[0]):this.timeline_view=new ThriveUlt.views.Timeline({model:this.model,el:this.$("#tvu-timeline-wrapper")[0],collection:this.model.get("timeline")}),this.timeline_view.render()},renderConversionEvents:function(){this.conversion_view?this.conversion_view.setElement(this.$("#tvu-conversion-wrapper")[0]):this.conversion_view=new ThriveUlt.views.ConversionEvents({model:this.model,el:this.$("#tvu-conversion-wrapper")[0],collection:this.model.get("conversion_events")}),this.conversion_view.render()},updateDashboardCampaignType:function(){try{var a=ThriveUlt.globals.campaigns.findWhere({ID:this.model.get("ID")});a instanceof ThriveUlt.models.Campaign&&a.set("type",this.model.get("type"))}catch(a){console.log("Error: "+a)}},fetchEvents:function(){this.model.get("timeline").fetch({reset:!0,data:{campaign_id:this.model.get("ID")}})}}),ThriveUlt.views.LockdownNormalState=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("campaign/lockdown/normal-state"),render:function(){return this.$el.html(this.template({item:this.model})),this}}),ThriveUlt.views.LockdownPromotionURL=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("campaign/lockdown/promotion-url"),className:"tvd-input-field",initialize:function(a){this.parent_model=a.parent_model,this.listenTo(this.model,"change",this.collection.generateEmailLink)},render:function(){function b(){e.set(e.defaults)}function c(){var b=a(this);e.set({value:b.val()})}function d(a,b){e.set(b.item)}var e=this.model,f=this.collection,g=this.collection.indexOf(this.model);this.$el.empty().append(this.template({model:e,key:g}));var h={url:ThriveUlt.ajaxurl("action="+ThriveUlt.ajax_actions.admin_controller+"&route=progressiveGetPosts"),no_value_callback:b,change_callback:c,select:d,collection:f};return new ThriveUlt.PostSearch(this.$el.find("#tvu-promotion-url"+g),h),this}}),ThriveUlt.views.LockdownServiceURL=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("campaign/lockdown/link-generation"),className:"tvd-copy-row tvd-row tvd-collapse tvd-no-mb tvu-url-container",initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"change",this.bindZclip)},render:function(){var a=this.collection.indexOf(this.model);return this.$el.empty().append(this.template({model:this.model,key:a})),this},bindZclip:function(){ZeroClipboard.Client.prototype.destroy(),this.$el.find(".zclip").remove(),TVE_Dash.bindZClip(this.$el.find("a.tve-copy-to-clipboard"))}}),ThriveUlt.views.LockdownDeleteState=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("campaign/lockdown/delete-state"),events:{"click .tvu-delete-no":"switchNormal","click .tvu-delete-yes":"save"},render:function(){return this.$el.html(this.template({item:this.model})),this},switchNormal:function(){this.model.set("lockdown_state",ThriveUlt.util.states.normal)},save:function(){this.model.set("lockdown",""),this.model.get("settings").trigger.type=ThriveUlt.util.triggerType.first;var a=this;TVE_Dash.showLoader(),this.model.save().done(function(){TVE_Dash.hideLoader();try{ThriveUlt.globals.campaign.set(a.model.toJSON())}catch(a){console.log("Error: "+a)}}).error(function(){TVE_Dash.hideLoader()}),this.switchNormal()}}),ThriveUlt.views.CampaignTypeAbsoluteState=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("campaign/type/absolute-state"),events:{"change #tvu-end-date":"setEndDate","change #tvu-start-date":"setStartDate"},default_settings:{end:{time:"00:00"},start:{time:"00:00"}},initialize:function(){var b=a.extend(!0,this.default_settings,this.model.get("settings"));this.model.set("settings",b)},render:function(){var b=this.model;return this.$el.html(this.template({item:this.model.get("settings")})),TVE_Dash.materialize(this.$el),this.$el.find("#tvu-start-date, #tvu-end-date").pickadate({format:"d mmmm yyyy",selectYears:!0,selectMonths:!0}),this.$el.find("#tvu-start-hour").timepicker({timeFormat:"HH:mm",dynamic:!1,interval:60,change:function(){var c=a(this).removeClass("tvd-invalid").val(),d=a(this),e=b.roundTime(c);d.val(e),b.get("settings").start.time=e}}),this.$el.find("#tvu-end-hour").timepicker({timeFormat:"HH:mm",dynamic:!1,interval:60,change:function(){var c=a(this).removeClass("tvd-invalid").val(),d=a(this),e=b.roundTime(c);d.val(e),b.setTime(e)}}),this},setStartDate:function(b){a(b.target).removeClass("tvd-invalid"),this.model.get("settings").start.date=b.target.value},setEndDate:function(b){if(a(b.target).removeClass("tvd-invalid"),"object"==typeof this.model.get("settings").end)this.model.get("settings").end.date=b.target.value;else{var c={date:b.target.value,time:""};this.model.get("settings").end=c}}}),ThriveUlt.views.CampaignTypeRollingState=ThriveUlt.views.Base.extend({className:"tvu-campaign-option tvu-campaign-rolling",template:TVE_Dash.tpl("campaign/type/rolling-state"),default_settings:{start:{time:"00:00"},end:{time:"00:00"}},events:{"change select.tvu-rolling-repeat":"changeDescription","change #tvu-select-recurrence-change":"changeRollingState","click #tve-rolling-end-never":function(){this.$("#tvu-end-date").removeClass("tvd-invalid").val(""),this.$('label[for="tvu-end-date"]').removeClass(),this.$("#tvu-end-hour").removeClass("tvd-invalid").val(""),this.$('label[for="tvu-end-hour"]').removeClass(),this.$("#tvu-rolling-end-after-in").removeClass("tvd-invalid").val(""),this.$('label[for="tvu-rolling-end-after-in"]').removeClass("tvd-active"),this.model.get("settings").end=null},"click #tve-rolling-end-after":function(){this.$("#tvu-end-date").removeClass("tvd-invalid").val(""),this.$('label[for="tvu-end-date"]').removeClass(),this.$("#tvu-end-hour").removeClass("tvd-invalid").val(""),this.$('label[for="tvu-end-hour"]').removeClass();var a=this.$("#tvu-rolling-end-after-in");a.focus(),"string"!=typeof this.model.get("settings").end&&(this.model.get("settings").end="1",a.val("1"))},"change #tvu-rolling-end-after-in":function(a){this.model.get("settings").end=a.target.value},"click #tvu-rolling-end-after-in":function(){this.$("#tvu-end-date").removeClass("tvd-invalid").val(""),this.$('label[for="tvu-end-date"]').removeClass(),this.$("#tvu-end-hour").removeClass("tvd-invalid").val(""),this.$('label[for="tvu-end-hour"]').removeClass(),this.$("#tve-rolling-end-after").attr("checked","checked"),"string"!=typeof this.model.get("settings").end&&(this.model.get("settings").end="1",this.$("#tvu-rolling-end-after-in").val("1"))},"click #tve-rolling-end-on":function(){this.$el.find("#tvu-end-date").trigger("click").focus()},"click #tvu-end-date":function(){this.$("#tvu-rolling-end-after-in").removeClass("tvd-invalid").val(""),this.$('label[for="tvu-rolling-end-after-in"]').removeClass("tvd-active"),this.$("#tve-rolling-end-on").attr("checked","checked"),null!==this.model.get("settings").end&&"object"==typeof this.model.get("settings").end||(this.model.get("settings").end={date:"",time:""})},"change #tvu-end-date":function(b){a(b.target).removeClass("tvd-invalid"),this.model.get("settings").end.date=b.target.value},"click #tvu-end-hour":function(b){this.$("#tvu-rolling-end-after-in").removeClass("tvd-invalid").val(""),this.$('label[for="tvu-rolling-end-after-in"]').removeClass("tvd-active"),this.$("#tve-rolling-end-on").attr("checked","checked"),a(b.target).removeClass("tvd-invalid")},"change #tvu-end-hour":function(b){a(b.target).removeClass("tvd-invalid")},"change #tvu-start-date":function(b){a(b.target).removeClass("tvd-invalid"),this.model.get("settings").start.date=b.target.value}},initialize:function(b){this.data=b,this.listenTo(this.model,"change:rolling_type",this.renderSettings);var c=a.extend(!0,this.default_settings,this.model.get("settings"));this.model.set("settings",c)},render:function(){var b=this;return this.$el.html(this.template({item:this.model,settings:this.model.get("settings")})),TVE_Dash.materialize(this.$el),this.renderSettings(),this.$el.find("#tvu-start-date, #tvu-end-date").pickadate({format:"d mmmm yyyy",selectYears:!0,selectMonths:!0}),this.$el.find("#tvu-start-hour").timepicker({timeFormat:"HH:mm",dynamic:!1,interval:60,change:function(){var c=a(this).removeClass("tvd-invalid").val(),d=a(this),e=b.model.roundTime(c);d.val(e),b.model.get("settings").start.time=a(this).removeClass("tvd-invalid").val()}}),this.$el.find("#tvu-end-hour").timepicker({timeFormat:"HH:mm",dynamic:!1,interval:60,change:function(){var c=a(this).removeClass("tvd-invalid").val(),d=a(this),e=b.model.roundTime(c);d.val(e),b.model.setTime(a(this).removeClass("tvd-invalid").val())}}),this},renderSettings:function(){var a=this.model.get("rolling_type");a||(a=ThriveUlt.util.rollingType.daily),this.collection.setOptions(this.model.get("settings").duration,a,this.model.get("settings").repeatOn),this[a]?this[a].setElement(this.$("#tvu-rolling-options")[0]):this[a]=new(ThriveUlt.views["Rolling"+ThriveUlt.util.upperFirst(a)+"Settings"])({el:this.$el.find("#tvu-rolling-options")[0],model:this.model,collection:this.collection}),this.changeDescription();var b=this.collection.prepareAppend();return b&&this.$el.find(".tvu-campaign-rolling-day").show().text("on "+b),this[a].render(),this[a].$el.hide().fadeIn().slideDown(),this},changeRollingState:function(a){var b=a.target.value;this.$el.find(".tvu-campaign-rolling-repeat, .tvu-campaign-rolling-day").empty(),this.model.get("settings").repeatOn=[],this.model.get("settings").repeat=1,this.model.get("settings").duration=1,this.model.set("rolling_type",b)},changeDescription:function(a){var b=this.model.changeRepeat(a);this.$el.find(".tvu-campaign-rolling-repeat").text(b)}}),ThriveUlt.views.CampaignTypeEvergreenState=ThriveUlt.views.Base.extend({className:"tvu-campaign-option tvu-campaign-evergreen",template:TVE_Dash.tpl("campaign/type/evergeen-state"),events:{"click .tvu-evergreen-settings":"changeEvergreenState","change #tvu-evergreen-days":function(a){this.model.get("settings").duration=a.target.value},"change #tvu-evergreen-expire":function(a){this.model.get("settings").end=a.target.value},"click .tvu-lead-conversion":"saveCheckboxes","change .tvu-repeat-switch":"changeRepeat","change .tvu-real-time":"changeRealEnding","change .tvu-lockdown-switch":"changeLockdown"},initialize:function(a){this.shortcodes=a.shortcodes},render:function(){var b=this.model.get("linked_to"),c=this.model;return this.$el.html(this.template({item:this.model.get("settings"),lockdown:this.model.get("lockdown"),collection:this.collection})),this.renderSettings(),b&&b.length>0&&b.each(this.renderLinkedCampaign,this),TVE_Dash.materialize(this.$el),this.$el.find("#tvu-real-time").timepicker({timeFormat:"HH:mm",dynamic:!1,interval:60,change:function(){var b=a(this).removeClass("tvd-invalid").val(),d=a(this),e=c.roundTime(b);d.val(e),c.get("settings").realtime=e}}),this},renderSettings:function(){var a=this.model.get("settings").trigger.type;if(a!=ThriveUlt.util.trigger_type.conversion||this.shortcodes||this.collection||(this.model.get("settings").trigger.type=""),ThriveUlt.views["Evergreen"+ThriveUlt.util.upperFirst(a)+"Settings"]){var b=new(ThriveUlt.views["Evergreen"+ThriveUlt.util.upperFirst(a)+"Settings"])({el:this.$el.find("#tvu-evergreen-settings"),model:this.model,collection:this.collection,shortcodes:this.shortcodes});b.render(),this.$("#tvu-trigger-description").html(b.get_trigger_description()),b.$el.hide().fadeIn().slideDown()}},changeEvergreenState:function(a){var b=a.target.value;this.model.get("settings").trigger.type=b,this.model.get("settings").trigger.ids="",this.renderSettings()},renderLinkedCampaign:function(a){var b=new ThriveUlt.views.LinkedCampaign({model:a});return this.$el.find(".tvu-evergreen-linked").show(),this.$el.find(".tvu-evergreen-linked-to").append(b.render().$el),this},saveCheckboxes:function(){var b=[];this.$el.find("input[type=checkbox].tvu-lead-conversion:checked").each(function(){var c=parseInt(a(this).val());b.push(c)}),this.model.get("settings").trigger.ids=b},changeRepeat:function(b){if(a(b.currentTarget).is(":checked"))return this.model.get("settings").evergreen_repeat=1,void this.$el.find(".tvu-repeat-wrapper").slideDown(200);this.model.get("settings").evergreen_repeat=0,this.model.get("settings").end="",this.$el.find("#tvu-evergreen-expire").val(""),this.$el.find(".tvu-repeat-wrapper").slideUp(200)},changeRealEnding:function(b){if(a(b.currentTarget).is(":checked"))return this.model.get("settings").real=1,void this.$el.find(".tvu-real-time-wrapper").slideDown(200);this.model.get("settings").real=0,this.model.get("settings").realtime="00:00",this.$el.find("#tvu-real-time").val("00:00"),this.$el.find(".tvu-real-time-wrapper").slideUp(200)},changeLockdown:function(b){var c=a(b.currentTarget);this.model.set("lockdown",c.is(":checked")),this.model.get("settings").trigger.type="",!this.model.get("lockdown")||this.model.get("status")!=ThriveUlt.util.status.running||this.model.get("lockdown_settings").expired&&this.model.get("lockdown_settings").preaccess&&this.model.get("lockdown_settings").promotion||(this.model.set("status",ThriveUlt.util.status.paused),this.model.saveStatus(),TVE_Dash.err(ThriveUlt.t.Campaign_paused)),this.render()}}),ThriveUlt.views.LinkedCampaign=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("campaign/type/evergreen-linked"),render:function(){return this.$el.empty().append(this.template({item:this.model})),this}}),ThriveUlt.views.EvergreenConversionSettings=ThriveUlt.views.Base.extend({className:"tvu-trigger-option tvu-trigger-option-conversion",template:TVE_Dash.tpl("campaign/type/evergreen-conversion"),initialize:function(a){this.shortcodes=a.shortcodes},render:function(){return this.$el.html(this.template({item:this.model.get("settings").trigger,collection:this.collection,shortcodes:this.shortcodes})),this.collection&&this.shortcodes&&(this.collection.each(this.renderLeadGroups,this),this.shortcodes.each(this.renderShortcodes,this)),TVE_Dash.materialize(this.$el),this},renderLeadGroups:function(a){var b=new ThriveUlt.views.EvergreenCampaignCheckbox({model:a,triggers:this.model.get("settings").trigger});return this.$el.find(".tvu-evergreen-leads-checkboxes").append(b.render().$el),this},renderShortcodes:function(a){var b=new ThriveUlt.views.EvergreenCampaignCheckbox({model:a,triggers:this.model.get("settings").trigger});return this.$el.find(".tvu-evergreen-shortcodes-checkboxes").append(b.render().$el),this},get_trigger_description:function(){return"<em>"+ThriveUlt.t.trigger_conversion+"</em>"}}),ThriveUlt.views.EvergreenCampaignCheckbox=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("campaign/type/evergreen-checkbox"),tagName:"div",className:"tvu-posts-checkbox tvd-col tvd-s4",initialize:function(a){this.triggers=a.triggers},render:function(){return this.$el.empty().append(this.template({item:this.model,ids:this.triggers.ids.constructor===Array?this.triggers.ids:""})),this}}),ThriveUlt.views.EvergreenFirstSettings=ThriveUlt.views.Base.extend({render:function(){return this.$el.empty(),this},get_trigger_description:function(){return"<em>"+ThriveUlt.t.trigger_first_visit+"</em>"}}),ThriveUlt.views.EvergreenPromotionSettings=ThriveUlt.views.Base.extend({render:function(){return this.$el.empty(),this},get_trigger_description:function(){return"<em>"+ThriveUlt.t.trigger_promotion_page+"</em>"}}),ThriveUlt.views.EvergreenUrlSettings=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("campaign/type/evergreen-specific"),render:function(){var a=this.model;this.$el.html(this.template({item:this.model.get("settings").trigger}));var b=this.$("#tvu-specific-url");return new ThriveUlt.PostSearch(b,{url:ThriveUlt.ajaxurl("action="+ThriveUlt.ajax_actions.admin_controller+"&route=progressiveGetPosts"),select:function(b,c){a.get("settings").trigger.ids=c.item.id},search:function(){a.get("settings").trigger.ids=""},open:function(){a.get("settings").trigger.ids=""},fetch_single:a.get("settings").trigger.ids}),this},get_trigger_description:function(){return"<em>"+ThriveUlt.t.trigger_url+"</em>"}}),ThriveUlt.views.RollingDailySettings=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("campaign/type/daily-campaign"),events:{"change #tvu-rolling-day-duration":function(a){this.model.get("settings").duration=a.target.value}},render:function(){return this.$el.html(this.template({item:this.model.get("settings")})),TVE_Dash.materialize(this.$el),this}}),ThriveUlt.views.RollingWeeklySettings=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("campaign/type/weekly-campaign"),events:{"change #tvu-rolling-duration":function(b){this.model.get("settings").duration=b.target.value,this.collection.each(function(a){a.set({disabled:!1,checked:!1})},this),a(".tvu-campaign-rolling-day").empty(),this.render()}},render:function(){return this.$el.empty(),this.$el.html(this.template({item:this.model.get("settings")})),this.$c_wrapper=this.$(".tvu-weekly-repeats-wrapper"),this.collection.each(this.renderOne,this),TVE_Dash.materialize(this.$el),this},renderOne:function(a){var b=new ThriveUlt.views.RollingCampaignCheckbox({model:a,collection:this.collection});return this.$c_wrapper.append(b.render().$el),this}}),ThriveUlt.views.RollingMonthlySettings=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("campaign/type/monthly-campaign"),events:{"change #tvu-rolling-duration":function(a){this.model.get("settings").duration=a.target.value,this.collection.each(function(a){a.set({disabled:!1,checked:!1})},this),this.render()}},render:function(){return this.$el.html(this.template({item:this.model.get("settings")})),this.$c_wrapper=this.$(".tvu-monthly-repeats-wrapper"),this.collection.each(this.renderOne,this),TVE_Dash.materialize(this.$el),this},renderOne:function(a){var b=new ThriveUlt.views.RollingCampaignCheckbox({model:a,collection:this.collection});return this.$c_wrapper.append(b.render().$el),this}}),ThriveUlt.views.RollingYearlySettings=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("campaign/type/yearly-campaign"),events:{"change #tvu-rolling-year-duration":function(){this.model.get("settings").duration=this.$el.find("#tvu-rolling-year-duration").val()}},render:function(){return this.$el.html(this.template({item:this.model.get("settings")})),TVE_Dash.materialize(this.$el),this}}),ThriveUlt.views.RollingCampaignCheckbox=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("campaign/type/checkbox"),tagName:"span",className:"tvu-repeat-checkbox",events:{"click .tvu-rolling-repeat-check":"prepareCheckboxes"},initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){return this.$el.empty().append(this.template({item:this.model})),this},prepareCheckboxes:function(b){var c=a("#tvu-rolling-options").find("#tvu-rolling-duration").val(),d=this.model.get("ID"),e=this.model.get("checked");this.collection.changeCheckboxes(c,d),this.model.set("checked",!e);var f=this.collection.prepareAppend();a(".tvu-campaign-rolling-day").show().text("on "+f)}}),ThriveUlt.views.Design=ThriveUlt.views.Base.extend({events:{"click .tvu-delete-design":function(){this.model.set("state","delete")},"click .tvu-edit-design":function(){this.model.initRefetchTimer()},"click .tvu-get-shortcode":"openShortcodeModal"},initialize:function(){this.listenTo(this.model,"change:state",this.renderState),this.listenTo(this.model,"change:thumb_url",this.renderState)},render:function(){return this.renderState(),this},renderState:function(){var a=this.model.get("state");if(ThriveUlt.views["Design"+ThriveUlt.util.upperFirst(a)+"State"]){var b=new(ThriveUlt.views["Design"+ThriveUlt.util.upperFirst(a)+"State"])({model:this.model,collection:this.collection});return b.render(),this.$el.replaceWith(b.$el),this.setElement(b.$el),this}},openShortcodeModal:function(){this.modal(ThriveUlt.views.ModalShortcodeCode,{model:this.model})}}),ThriveUlt.views.DesignNormalState=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("design-item"),className:"tvd-col tvd-s12 tvd-m4 tvd-ms6 tvd-l3 tvu-design-item",events:{},render:function(){return this.$el.html(this.template({item:this.model})),this}}),ThriveUlt.views.DesignDeleteState=ThriveUlt.views.Base.extend({className:"tvd-col tvd-s12 tvd-m4 tvd-ms6 tvd-l3",template:TVE_Dash.tpl("design-delete-state"),events:{"click .tvu-delete-yes":"yes",keydown:"keyAction","click. .tvu-delete-no":function(){this.model.set("state",ThriveUlt.util.states.normal)}},initialize:function(){this.listenTo(this.collection,"remove",this.remove)},render:function(){this.$el.html(this.template({item:this.model}));var a=this;return _.defer(function(){a.$(".tve-delete-design-card").focus()}),this},keyAction:function(a){var b=a.which;13==b?this.yes():27==b&&this.model.set("state",ThriveUlt.util.states.normal)},yes:function(){var a=this;TVE_Dash.cardLoader(this.$el),this.model.clearRefetchTimer(),this.model.destroy({wait:!0,success:function(b,c){a.collection.remove({ID:a.model.get("ID")}),c.campaign_paused&&(ThriveUlt.globals.campaign.set("status",c.campaign_status),TVE_Dash.err(c.campaign_paused,6e3))},error:function(){TVE_Dash.hideLoader()}})}}),ThriveUlt.views.TextEdit=ThriveUlt.views.Base.extend({className:"tvd-input-field tvu-inline-edit",template:TVE_Dash.tpl("textedit"),events:{"keyup input":"keyup","change input":function(b){return a.trim(this.input.val())?(this.model.set("value",this.input.val()),!1):(this.input.addClass("tvd-invalid"),!1)},"blur input":function(){this.model.trigger("tvu_no_change")}},keyup:function(a){27===a.which&&this.model.trigger("tvu_no_change")},render:function(){return this.$el.html(this.template({item:this.model})),this.input=this.$el.find("input"),this},focus:function(){this.input.focus().select()}}),ThriveUlt.views.Timeline=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("campaign/timeline"),events:{"click #tvu-add-timeline-event":"addEvent"},initialize:function(){this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"update",this.render)},render:function(){return this.$el.html(this.template({item:this.model})),this.collection.each(_.bind(this.renderEvent,this)),this},renderEvent:function(a){if(a.get("type")===ThriveUlt.event_type.end)return this.renderEndEvent(a);var b=new ThriveUlt.views.Event({model:a,collection:this.collection});return this.$("#tvu-timeline").append(b.render().$el),this},renderEndEvent:function(a){var b=new ThriveUlt.views.EndEvent({model:a,collection:this.collection});return this.$("#tvu-timeline").append(b.render().$el),this},addEvent:function(){if(!this.model.get("designs")||!this.model.get("designs").size())return void TVE_Dash.err(ThriveUlt.t.NoDesigns);var a=new ThriveUlt.models.Event({campaign_id:this.model.get("ID")}),b=this.collection.at(this.collection.size()-2),c=new ThriveUlt.collections.EventActions(b.get("actions").toJSON());a.set("actions",c),ThriveUlt.views.Timeline.openEventModal(a,null,this.collection)}},{openEventModal:function(a,b,c){TVE_Dash.showLoader();var d=new ThriveUlt.collections.Designs;d.set_campaign_id(a.get("campaign_id")).fetch().done(_.bind(function(){d.mark_selected_event_actions(a.get("actions")),ThriveUlt.globals.campaign.set("designs",d),this.prototype.modal(ThriveUlt.views.ModalEditEvent,{model:a,original_model:b,designs:d,collection:c,"max-width":"45%"})},this)).fail(function(a){TVE_Dash.err(a.responseText)}).always(function(){TVE_Dash.hideLoader()})}}),ThriveUlt.views.Event=ThriveUlt.views.Base.extend({className:"tvu-timeline-row",newClassName:"tvu-animation-edit",durationClassName:"tvu-animation-duration",deleteClassName:"tvu-deleting",template:TVE_Dash.tpl("event/item"),events:{"click .tvu-event-edit":"edit","click .tvu-event-delete":"delete"},initialize:function(){this.listenTo(this.model,"destroy",this.remove)},render:function(){return this.$el.html(this.template({item:this.model})),this.$actionsList=this.$el.find(".tvu-event-actions"),this.renderActions(),"edited"===this.model.get("status")&&(this.$el.addClass(this.newClassName),this.model.unset("status")),"duration_changed"!==this.model.get("status")&&"new"!==this.model.get("status")||(this.$el.addClass(this.durationClassName),setTimeout(_.bind(function(){this.model.unset("status")},this),2e3)),setTimeout(_.bind(function(){this.$el.removeClass(this.newClassName+"  "+this.durationClassName)},this),2e3),this},renderActions:function(){this.$actionsList.empty();var a=this.model.get("actions").models;a.length>0?_.each(a,function(a){this.$actionsList.append(TVE_Dash.tpl("event/action",{item:a}))},this):this.$actionsList.append("There are no Designs attached to this event. To add a new Design edit the event.")},edit:function(){ThriveUlt.views.Timeline.openEventModal(this.model.deepClone(),this.model,this.collection)},delete:function(){this.$el.addClass(this.deleteClassName),setTimeout(_.bind(function(){this.model.destroy({success:function(a,b,c){TVE_Dash.hideLoader()},error:function(a,b,c){TVE_Dash.hideLoader(),TVE_Dash.err(b.responseText)}})},this),500)}}),ThriveUlt.views.EndEvent=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("event/end"),className:"tvu-timeline-row tvu-timeline-row-last",render:function(){return this.$el.html(this.template({item:this.model})),this}}),ThriveUlt.views.EventModalDesignItem=ThriveUlt.views.Base.extend({tagName:"li",template:TVE_Dash.tpl("event/design-row"),className:"tvu-event-design-item tvd-collection-item",events:{"change .tvu-event-design-display":"eventDisplayChange","change .tvu-event-design-state":"eventStateChange"},eventDisplayChange:function(b){var c=a(b.target);this.model.set("event_display",c.is(":checked")),this.$(".tvu-event-design-state-container")[c.is(":checked")?"fadeIn":"fadeOut"](150)},eventStateChange:function(b){var c=a(b.target).val();this.model.set("event_state",c)},render:function(){return this.$el.html(this.template({design:this.model})),this.$(".tvu-event-design-state").trigger("change"),this}}),ThriveUlt.views.ConversionEvents=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("campaign/conversion_events"),events:{"click #tvu-add-conversion-event":"addEvent"},initialize:function(){this.listenTo(this.collection,"add",this.renderOne)},render:function(){return this.$el.html(this.template({item:this.model})),this.collection.each(this.renderOne,this),this},addEvent:function(){var a=new ThriveUlt.models.ConversionEvent({campaign_id:this.model.get("ID")});a.set("trigger_options",{end_id:"",event:"",trigger:"",trigger_ids:""}),this.modal(ThriveUlt.views.ModalConversionEvent,{model:a,collection:this.collection,"max-width":"40%"})},renderOne:function(a){var b=new ThriveUlt.collections.Campaigns(ThriveUlt.globals.campaigns.where({type:ThriveUlt.util.campaignType.evergreen})),c=new ThriveUlt.views.ConversionEvent({model:a,collection:b});return this.$el.find("#tvu-conversion-events").append(c.render().$el),this}}),ThriveUlt.views.ConversionEvent=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("conversion/event"),tagName:"div",className:"tvu-conversion-event",events:{"click .tvu-campaign-delete":"delete","click .tvu-campaign-edit":"editEvent"},initialize:function(){this.listenTo(this.model,"destroy",this.remove),this.listenTo(this.model,"change",this.render)},render:function(){var a=ThriveUlt.globals.campaigns.findWhere({ID:parseInt(this.model.get("trigger_options").end_id)}),b=this;return a&&a.createModelCollections(),b.$el.empty().append(b.template({item:b.model,campaign:a})),this},delete:function(){TVE_Dash.showLoader(),this.model.destroy({success:function(a,b,c){TVE_Dash.hideLoader()},error:function(a,b,c){TVE_Dash.hideLoader(),TVE_Dash.err(b.responseText)}})},editEvent:function(){this.modal(ThriveUlt.views.ModalConversionEvent,{model:this.model.deepClone(),original_model:this.model,collection:this.collection,"max-width":"40%"})}}),ThriveUlt.views.ConversionSummary=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("conversion/conversion-summary"),render:function(){return this.$el.html(this.template({item:this.model})),this}}),ThriveUlt.views.TriggerTypeSpecific=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("conversion/visit-page"),events:{},render:function(){var a=this.model;this.$el.html(this.template({
item:this.model})),new ThriveUlt.PostSearch(this.$("#tvu-specific-url"),{url:ThriveUlt.ajaxurl("action="+ThriveUlt.ajax_actions.admin_controller+"&route=progressiveGetPosts"),select:function(b,c){a.get("trigger_options").trigger_ids=c.item.id},no_value_callback:function(){a.get("trigger_options").trigger_ids=""},fetch_single:a.get("trigger_options").trigger_ids})}}),ThriveUlt.views.TriggerTypeConversion=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("conversion/subscription"),events:{"click .tvu-lead-conversion":"saveCheckboxes"},initialize:function(a){this.shortcodes=a.shortcodes},render:function(){this.$el.html(this.template({collection:this.collection,shortcodes:this.shortcodes,item:this.model})),this.collection.each(this.renderLeads,this),this.shortcodes.each(this.renderLeads,this)},renderLeads:function(a){var b=new ThriveUlt.views.ConversionCheckbox({model:a,triggers:this.model.get("trigger_options").trigger_ids});return a.get("post_type")===ThriveUlt.util.leadtype.lead_group?this.$el.find(".tvu-conversion-leads-checkboxes").append(b.render().$el):this.$el.find(".tvu-conversion-shortcodes-checkboxes").append(b.render().$el),this},saveCheckboxes:function(){var b=[];this.$el.find("input[type=checkbox]:checked").each(function(){var c=parseInt(a(this).val());b.push(c)}),this.model.get("trigger_options").trigger_ids=b}}),ThriveUlt.views.ConversionCheckbox=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("conversion/subscription-checkbox"),className:"tvu-posts-checkbox tvd-col tvd-s4",initialize:function(a){this.triggers=a.triggers},render:function(){return this.$el.empty().append(this.template({item:this.model,ids:this.triggers?this.triggers:""})),this}}),ThriveUlt.views.EventTypeEnd=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("conversion/move-to-campaign"),render:function(){return this.$el.empty(),this}}),ThriveUlt.views.EventTypeMove=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("conversion/move-to-campaign"),events:{"click .tvu-campaign-conversion":"setMove"},render:function(){return this.$el.html(this.template({item:this.model,collection:this.collection})),this.collection.each(this.renderOne,this),this},renderOne:function(a){var b=this.model.get("trigger_options").end_id,c=new ThriveUlt.views.ConversionRadio({model:a,end_id:b||""});return this.$el.find("#tvu-campaign-move-wrapper").append(c.render().$el),this},setMove:function(a){var b=a.target.value;if(this.model.get("ID")){var c=this.model.get("trigger_options").end_id;this.model.get("trigger_options").end_id_old=c}this.model.get("trigger_options").end_id=b}}),ThriveUlt.views.ConversionRadio=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("conversion/move-to-campaign-radio"),className:"tvu-caimpaigns-radio tvd-col tvd-s4",initialize:function(a){this.end_id=a.end_id},render:function(){return this.$el.empty().append(this.template({item:this.model,end_id:this.end_id?this.end_id:""})),this}}),ThriveUlt.views.Breadcrumbs=ThriveUlt.views.Base.extend({el:a("#tvu-breadcrumbs-wrapper")[0],template:TVE_Dash.tpl("breadcrumbs"),initialize:function(){this.$title=a("head > title"),this.original_title=this.$title.html(),this.listenTo(this.collection,"change",this.render),this.listenTo(this.collection,"add",this.render)},render:function(){this.$el.empty().html(this.template({links:this.collection}))}})}),ThriveUlt.PostSearch=function(b,c){function d(){var a;return!!(a=b.data("allow-regex"))&&b.val().match(new RegExp(a))}c=c||{},c.no_value_callback=c.no_value_callback||a.noop,c.change_callback=c.change_callback||a.noop;var e={appendTo:b.parent(),minLength:2,delay:200,change:function(a,e){e.item||b.data("value-filled")||d()||(b.val(""),c.no_value_callback.apply(b,arguments)),b.data("value-filled",null),d()&&c.change_callback.apply(b,arguments)}};c=a.extend(!0,e,c),c.source||(c.source=c.url),b.autocomplete(c).data("ui-autocomplete")._renderItem=function(b,d){var e="";if(c.collection&&c.collection.length){c.collection.findWhere({id:d.id})&&(e="tvu-selected-post")}return a("<li class='"+e+"'>").append("<span class='tvu-ps-result-title'>"+d.label+"</span><span class='tvu-ps-result-type'>"+d.type+"</span>").appendTo(b)},b.on("blur",function(){a.trim(this.value).length||c.no_value_callback.apply(b,arguments)}),c.fetch_single&&"number"==typeof c.fetch_single&&(b.addClass("ui-autocomplete-loading"),a.ajax({url:ThriveUlt.ajaxurl("action="+ThriveUlt.ajax_actions.admin_controller+"&route=getPostByID"),data:{id:c.fetch_single},success:function(a){b.data("value-filled",1).val(a.title).removeClass("ui-autocomplete-loading").next("label").addClass("tvd-active")}})),c.fetch_single&&"string"==typeof c.fetch_single&&b.data("value-filled",1).val(c.fetch_single).next("label").addClass("tvd-active")}}(jQuery);var ThriveUlt=ThriveUlt||{};ThriveUlt.globals=ThriveUlt.globals||{},function(a){var b=Backbone.Router.extend({view:null,editCampaignView:null,$el:a("#tvu-admin-wrapper"),routes:{dashboard:"dashboard","dashboard/campaign/:id":"campaignEdit","purge-cache":"purgeCache","dashboard/archived-campaigns":"archived"},params:{},breadcrumbs:{col:null,view:null},init_breadcrumbs:function(){this.breadcrumbs.col=new ThriveUlt.collections.Breadcrumbs,this.breadcrumbs.view=new ThriveUlt.views.Breadcrumbs({collection:this.breadcrumbs.col})},set_page:function(b,c,d){this.breadcrumbs.col.reset(),d=d||{},this.breadcrumbs.col.add_page(ThriveUlt.dash_url,ThriveUlt.t.Thrive_Dashboard,!0),_.each(d,_.bind(function(a){this.breadcrumbs.col.add_page(a.route,a.label)},this)),this.breadcrumbs.col.add_page("",c);var e=a("head > title");this.original_title||(this.original_title=e.html()),e.html(c+" &lsaquo; "+this.original_title)},dashboard:function(){this.set_page("dashboard",ThriveUlt.t.Dashboard),a(".tvd-material-tooltip").hide(),TVE_Dash.opened_modal_view&&TVE_Dash.opened_modal_view.close(),TVE_Dash.showLoader(),this.view&&this.view.remove(),this.renderHeader(),this.view=new ThriveUlt.views.Dashboard({collection:new ThriveUlt.collections.Campaigns(ThriveUlt.globals.campaigns.filter_archived(!1))}),this.$el.html(this.view.render().$el),ThriveUlt.util.bind_wistia()},archived:function(){this.set_page("archived-campaigns",ThriveUlt.t.archived_campaigns,[{route:"purge-cache",label:ThriveUlt.t.Dashboard}]),TVE_Dash.opened_modal_view&&TVE_Dash.opened_modal_view.close(),TVE_Dash.showLoader(),this.view&&this.view.remove(),this.view=new ThriveUlt.views.ArchivedCampaigns({collection:new ThriveUlt.collections.Campaigns(ThriveUlt.globals.campaigns.filter_archived())}),this.$el.html(this.view.render().$el),this.renderHeader(),TVE_Dash.hideLoader()},campaignEdit:function(b){function c(a,b){d.set_page(a,b,[{route:"purge-cache",label:ThriveUlt.t.Dashboard}])}if(this.view&&this.view.remove(),TVE_Dash.opened_modal_view&&TVE_Dash.opened_modal_view.close(),a(".tvd-material-tooltip").hide(),!b)return void ThriveUlt.router.navigate("#dashboard",{trigger:!0});var d=this,e=new ThriveUlt.models.Campaign({ID:b});TVE_Dash.showLoader(),this.renderHeader(),e.fetch().success(function(){ThriveUlt.globals.campaign=e,d.view=new ThriveUlt.views.EditCampaign({model:e}),d.$el.html(d.view.render().$el),c("dashboard/campaign",e.get("post_title")),e.on("change:post_title",function(){c("dashboard/campaign",e.get("post_title"))}),TVE_Dash.hideLoader(),ThriveUlt.util.bind_wistia()}).error(function(a){TVE_Dash.err(a.responseText),TVE_Dash.hideLoader()}),this.params.campaign=e},purgeCache:function(){TVE_Dash.showLoader(),a.ajax({type:"post",url:ajaxurl,dataType:"json",data:{action:ThriveUlt.ajax_actions.admin_controller,route:"settings",custom:"purge_cache",_nonce:ThriveUlt.admin_nonce}}).done(_.bind(function(a){ThriveUlt.globals.campaigns.reset(a),this.navigate("#dashboard",{trigger:!0})},this)).always(function(){TVE_Dash.hideLoader()})},renderHeader:function(){this.header?this.header.setElement(a(".tvu-header")):this.header=new ThriveUlt.views.Header({el:".tvu-header",model:ThriveUlt.globals.settings}),this.header.render()}});a(function(){ThriveUlt.globals.campaigns=new ThriveUlt.collections.Campaigns(ThriveUlt.data.campaigns),ThriveUlt.globals.actions=new ThriveUlt.collections.EventActions(ThriveUlt.data.actions),ThriveUlt.globals.settings=new ThriveUlt.models.Settings(ThriveUlt.data.settings),ThriveUlt.globals.date_formats=new ThriveUlt.models.Settings(ThriveUlt.date_formats),ThriveUlt.router=new b,ThriveUlt.router.init_breadcrumbs(),Backbone.history.start({hashchange:!0}),Backbone.history.fragment||ThriveUlt.router.navigate("#dashboard",{trigger:!0})})}(jQuery);var ThriveUlt=ThriveUlt||{};ThriveUlt.views=ThriveUlt.views||{},ThriveUlt.models=ThriveUlt.models||{},ThriveUlt.collections=ThriveUlt.collections||{},ThriveUlt.objects=ThriveUlt.objects||{},function(a){a(function(){ThriveUlt.models.Template=Backbone.Model.extend({defaults:{name:"",description:"",hangers:""},initialize:function(a,b){this.set("hangers",new Backbone.Collection([a.show_group_options,a.hide_group_options]))}}),ThriveUlt.collections.Templates=Backbone.Collection.extend({model:ThriveUlt.models.Template}),ThriveUlt.models.TemplateList=Backbone.Model.extend({defaults:{template_groups:[]},initialize:function(a){var b=[];_.each(a,function(a,c){var d=new ThriveUlt.collections.Templates(a);d.group_name=c,d.size()&&(d.group_tag=d.at(0).get("tag")),b.push(d)}),this.set("template_groups",b)},get_template:function(a){var b=null;return _.every(this.get("template_groups"),function(c){return!(b=c.findWhere(a))}),b},name_exists:function(a,b){var c=!1;return _.each(this.get("template_groups"),function(d){return d.group_tag!=b||(d.findWhere({name:a})?(c=!0,!1):void 0)}),c},size:function(){return this.get("template_groups").length}}),ThriveUlt.models.Filter=Backbone.Model.extend({defaults:{cssClass:"",identifier:"",label:""}}),ThriveUlt.collections.Filters=Backbone.Collection.extend({model:ThriveUlt.models.Filter}),ThriveUlt.models.Option=Backbone.Model.extend({defaults:{label:"",isChecked:!1,id:"",type:null},validate:function(a){if(!a.label.length)return alert("Empty links are not accepted !"),"just return something"},toggle:function(){this.set("isChecked",!this.get("isChecked"))},check:function(){this.set("isChecked",!0)},uncheck:function(){this.set("isChecked",!1)}}),ThriveUlt.collections.Options=Backbone.Collection.extend({model:ThriveUlt.models.Option,countCheckedOptions:function(){var a=0;return this.each(function(b){a+=b.get("isChecked")?1:0}),a}}),ThriveUlt.models.Tab=Backbone.Model.extend({defaults:function(){return{identifier:"",label:"",isActive:!1,actions:[],filters:[]}},initialize:function(a){this.set("options",new ThriveUlt.collections.Options(a.options)),this.set("filters",new ThriveUlt.collections.Filters(a.filters))},getTabIdentifierFromTabId:function(a){return a.replace("tvu_leads_tab_","")},getTabIdFromIdentifier:function(){return"tvu_leads_"+(this.get("exclusion")?"hide":"show")+"_tab_"+this.get("identifier")},getTabContentIdentifier:function(){return"tvu_leads_tab_content_"+this.get("identifier")},countCheckedOptions:function(){if("others"===this.get("identifier")){var a=0;return this.get("options").each(function(b){("direct_url"===b.get("type")||b.get("isChecked"))&&a++}),a}return this.get("options").countCheckedOptions()},uncheckAll:function(){var a=[],b=this.get("options");b.each(function(b){b.set("isChecked",!1),"direct_url"===b.get("type")&&a.push(b)}),_.forEach(a,function(a){b.remove(a)})}}),ThriveUlt.collections.Tabs=Backbone.Collection.extend({model:ThriveUlt.models.Tab}),ThriveUlt.models.Hanger=Backbone.Model.extend({defaults:function(){return{identifier:"",tabs:""}},initialize:function(a,b){this.set("tabs",new ThriveUlt.collections.Tabs(a.tabs))},countCheckedOptions:function(){var a=0;return this.get("tabs").each(function(b){a+=b.countCheckedOptions()}),a},uncheckAll:function(){this.get("tabs").each(function(a){a.uncheckAll()})},getDataForSave:function(){var a={tabs:[]};return this.get("tabs").each(function(b,c){a.tabs[c]=[],b.get("options").each(function(b){(b.get("isChecked")||"direct_url"==b.get("type"))&&a.tabs[c].push(b.get("id"))})}),a},get_selected_labels:function(a){var b=this.get("tabs"),c=[];return void 0===a&&(a=this.getDataForSave().tabs),_.each(a,function(a,d){_.each(a,function(a,e){c.push(b.at(d).get("options").findWhere({id:a}).get("label"))})}),c}}),ThriveUlt.collections.Hangers=Backbone.Collection.extend({model:ThriveUlt.models.Hanger,uncheckAll:function(){this.each(function(a){a.uncheckAll()})},get_display_summary:function(a){function b(b,c){var d;if(!b||!(d=b.length))return"";var e=b.slice(0,a).join(", ");return d>a&&(e+=" &amp; "+(d-a)+" "+ThriveUlt.t.more),e?c+" "+e:""}a=void 0===a?2:parseInt(a),a=isNaN(a)?2:a;var c=this.at(0).get_selected_labels(),d=this.at(1).get_selected_labels(),e=_.filter([b(c,ThriveUlt.t.Showing_on),b(d,ThriveUlt.t.Hidden_on)],function(a){return a.length>0});return e.length?e.join(". "):ThriveUlt.t.Not_set},has_saved_options:function(){return this.at(0).get_selected_labels().concat(this.at(1).get_selected_labels()).length>0}}),ThriveUlt.views.FiltersView=ThriveUlt.views.Base.extend({className:"tvu_leads_filtersContainer",events:{"click .tvu_leads_tabFilter":function(a){this.filterClicked(jQuery(a.target))}},initialize:function(){},render:function(){var a=this;_.each(this.collection.models,function(b){a.renderFilter(b)})},renderFilter:function(a){var b=TVE_Dash.tpl("campaign/settings/filter",a.toJSON());this.$el.append(b)},filterClicked:function(a){this.$el.find(".tvu_leads_tabFilter").removeClass("selected"),a.addClass("selected"),_.each(this.$el.parent().find(".tvu_leads_optionContainer,.tvu_leads_tab_content_toggle"),function(b){var c=jQuery(b);c.children("label").data("type")===a.attr("id")?c.show():c.hide()}),this.renderSelectedFilter(a.text())},renderSelectedFilter:function(a){var b=this.$el.next(".tvu_leads_selectedFilter");b.length&&b.remove();var c=TVE_Dash.tpl("campaign/settings/selected_filter",{filter:a});this.$el.after(c)}}),ThriveUlt.views.OptionView=ThriveUlt.views.Base.extend({className:"tvu_leads_optionContainer tvd-col tvd-s6 tvd-m6 tvd-l2",events:{"click .tvu_leads_toggle_option":"toggle","click .tvu_leads_removeDirectLink":"removeLink"},initialize:function(){this.listenTo(this.model,"change:isChecked",this.isCheckedChanged)},render:function(){if("direct_url"===this.model.get("type")){this.$el.removeClass("tvd-l2");var a=TVE_Dash.tpl("campaign/settings/direct_url",this.model.toJSON())}else var a=TVE_Dash.tpl("campaign/settings/option",this.model.toJSON());"item_page"===this.model.get("type")&&this.$el.removeClass("tvd-l2").addClass("tvd-l3"),this.$el.append(a)},toggle:function(){this.model.toggle()},isCheckedChanged:function(){this.$el.find('input[type="checkbox"]').prop("checked",this.model.get("isChecked"))},removeLink:function(){this.model.collection.remove(this.model)}}),ThriveUlt.views.tab_custom_views={_autocomplete:function(a,b,c){a.autocomplete({appendTo:a.parent(),minLength:2,delay:200,source:function(a,c){jQuery.ajax({url:ajaxurl,dataType:"json",data:{action:ThriveUlt.ajax_actions.admin_controller,route:b,q:a.term,tax:"post_tag",_nonce:ThriveUlt.admin_nonce}}).done(function(a){c(a)})},select:c})},taxonomy_terms:Backbone.View.extend({template:TVE_Dash.tpl("campaign/settings/tags_filter"),render:function(a){var b=this;return this.$el.html(this.template(this.model.attributes)),this.$el.addClass("tvu_leads_tab_content_toggle").hide(),ThriveUlt.views.tab_custom_views._autocomplete(this.$el.find(".tvu-leads-autocomplete"),"tagSearch",function(a,c){return b.model.get("options").add({isChecked:!0,type:"post_tag",id:c.item.id,label:c.item.label}),this.value="",!1}),a.find(".tvu_leads_selectedFilter").after(this.$el),this}}),posts:Backbone.View.extend({template:TVE_Dash.tpl("campaign/settings/posts_filter"),render:function(a){var b=this.model.get("options");this.$el.html(this.template(this.model.attributes)),ThriveUlt.views.tab_custom_views._autocomplete(this.$el.find(".tvu-leads-autocomplete"),"postSearch",function(a,c){return b.add({isChecked:!0,type:"",id:c.item.id,label:c.item.label}),this.value="",!1}),a.find(".tab-content-title").after(this.$el)}})},ThriveUlt.views.TabContentView=ThriveUlt.views.Base.extend({actionContainerClass:"tvu_leads_actionContainer",actionDefaultClass:"tvd-btn-flat tvd-btn-flat-dark tvd-waves-effect",className:"tvd-row",events:{"click .selectAll":"checkAll","click .selectNone":"checkNone","click .tvu_leads_addDirectLink":"addDirectLinkClicked","keypress .tvu_leads_directUrl":"addDirectLinkClicked"},initialize:function(){this.listenTo(this.model.get("options"),"add",function(a){this.renderOptions(a.get("type")),this.model.trigger("change",this.model)}),this.listenTo(this.model.get("options"),"remove",function(){this.renderOptions(),this.model.trigger("change",this.model)})},renderOthersTab:function(){this.$el.attr("id",this.model.getTabIdFromIdentifier()).append('<h5 class="tab-content-title">Visitor Status</h5>').append('<div class="tl-visitor-status clearfix"></div>').append('<div class="clear"></div><h5 class="tab-second-title">Direct URLs</h5>').append('<div class="tl-direct-urls tvd-row tvu_leads_tab_content_direct_urls clearfix"></div>'),this.renderOptionsOthers(),this.renderAddDirectUrlForm()},renderOptionsOthers:function(){this.$el.find(".tl-visitor-status").empty(),this.$el.find(".tl-direct-urls").empty();var a=this;_.each(this.model.get("options").models,function(b){var c="direct_url"==b.get("type")?a.$el.find(".tl-direct-urls"):a.$el.find(".tl-visitor-status");b.set("base_id",a.model.getTabIdFromIdentifier());var d=new ThriveUlt.views.OptionView({model:b});c.append(d.el),d.render(),b.on("change:isChecked",function(){a.model.trigger("change")})})},render:function(){if("others"===this.model.get("identifier"))return this.renderOthersTab();this.$el.append('<span class="tab-content-title"></span>').attr("id",this.model.getTabIdFromIdentifier()),this.renderActions(),this.renderOptions(),this.renderFilters(),this.renderCustomHtml()},renderCustomHtml:function(){if(ThriveUlt.views.tab_custom_views[this.model.get("identifier")]){new(ThriveUlt.views.tab_custom_views[this.model.get("identifier")])({model:this.model}).render(this.$el)}},renderOptions:function(a){if("others"===this.model.get("identifier"))return this.renderOptionsOthers();this.$el.find(".tvu_leads_optionContainer").remove();var b=this;_.each(this.model.get("options").models,function(c){b.renderOption(c,a),c.on("change:isChecked",function(){b.model.trigger("change",b.model)})})},renderOption:function(a,b){a.set("base_id",this.model.getTabIdFromIdentifier());var c=new ThriveUlt.views.OptionView({model:a});this.$el.append(c.el),c.render(),b&&a.get("type")!=b&&c.$el.hide()},renderActions:function(){if(this.model.get("actions").length){var a=jQuery('<div class="'+this.actionContainerClass+' tvu_leads_clearfix" />'),b=this;this.$el.append(a),this.model.get("actions").length&&_.each(this.model.get("actions"),function(a){b.$el.find("."+b.actionContainerClass).append('<a class="'+b.actionDefaultClass+" "+a.cssClass+'" href="javascript:void(0)">'+a.label+"</a>")})}},renderFilters:function(){if(this.model.get("filters").length){var a=new ThriveUlt.views.FiltersView({model:this.model,collection:this.model.get("filters")});a.render(),this.$el.find(".tab-content-title").after(a.el),a.filterClicked(a.$el.children().first())}},renderAddDirectUrlForm:function(){var a=TVE_Dash.tpl("campaign/settings/add_direct_url_form",{});this.$el.append(a)},checkAll:function(){_.each(this.model.get("options").models,function(a){a.check()})},checkNone:function(){_.each(this.model.get("options").models,function(a){a.uncheck()})},addDirectLinkClicked:function(a){if("keypress"!==a.type||13===a.which){var b=jQuery(a.target),c=b.parents(".tvd-add-link-row"),d=c.find("input");this.model.get("options").add({id:d.val().trim(),label:d.val().trim(),type:"direct_url"},{validate:!0}),d.val("")}}}),ThriveUlt.views.TabLabelView=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("campaign/settings/tab_label"),activeClass:"tvu_leads_active_tab",className:"tvd-tab",tagName:"li",events:{},initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){this.$el.html(this.template({tab:this.model}))}}),ThriveUlt.views.HangerView=ThriveUlt.views.Base.extend({template:TVE_Dash.tpl("campaign/settings/hanger"),initialize:function(){},render:function(){var a=this.template(this.model.toJSON()),b=this;this.$el.html(a),this.$tabLabelsContainer=this.$el.find(".tvu_leads_tabs"),this.$tabContentsContainer=this.$el.find(".tvu_leads_tabs_wrapper"),_.each(this.model.get("tabs").models,function(a){a.set("exclusion",b.model.get("identifier").indexOf("hide")>=0);var c=b.renderTabLabels(a),d=b.renderTabContent(a);a.on("change:isActive",_.bind(b.activateTab,b,c,d)),a.on("change",_.bind(function(){"hide_options"===this.model.get("identifier")?jQuery(".exclusions-count").html("("+this.model.countCheckedOptions()+")"):jQuery(".inclusions-count").html("("+this.model.countCheckedOptions()+")")},b,a))}),this.model.get("tabs").at(0).set("isActive",!0)},renderTabLabels:function(a){var b=new ThriveUlt.views.TabLabelView({model:a});return this.$tabLabelsContainer.append(b.el),b.render(),b},renderTabContent:function(a){var b=new ThriveUlt.views.TabContentView({model:a});return this.$tabContentsContainer.append(b.el),b.render(),b},activateTab:function(a,b,c,d){this.$tabLabelsContainer.find("li").removeClass(a.activeClass).find("a").removeClass("tvd-active"),this.$tabContentsContainer.find(".tvu_leads_tabs_content").hide(),a.$el.addClass(a.activeClass).find("> a").addClass("tvd-active"),b.$el.show(),c.attributes.isActive=!1}}),ThriveUlt.views.CampaignSettings=TVE_Dash.views.Modal.extend({template:TVE_Dash.tpl("campaign/settings/main"),events:{"click .tvu_leads_save_widget_options":"saveOptions","click .tvu_leads_add_new_template":"saveTemplate","click .tvu_leads_load_saved_options":"loadTemplate","click .tvd-modal-close":"close","click .tl-toggle-tab-display":"toggleTabDisplay","blur input#tvu_leads_new_template_name":function(b){a(b.target).removeClass("tvd-invalid")},"keyup input#tvu_leads_new_template_name":function(a){13===a.which&&this.saveTemplate()}},toggleTabDisplay:function(a){var b=jQuery(a.currentTarget),c=b.hasClass("collapsed"),d=jQuery(b.data("target"));c?d.hide(0).removeClass("tvd-not-visible").slideDown(200):d.slideUp(200,function(){d.addClass("tvd-not-visible")}),b.toggleClass("collapsed"),b.toggleClass("hover")},afterRender:function(){this.$templatesList=this.$el.find(".tvu_leads_saved_options");var a=this;_.each(this.collection.models,function(b){a.renderHangerView(b)}),this.$el.addClass("tvd-modal-fixed-footer tvd-modal-display-settings"),this.renderTemplatesList()},_render:function(){this.$el.html(this.template({model:this.model})),this.afterRender(),TVE_Dash.materialize(this.$el)},renderHangerView:function(a){new ThriveUlt.views.HangerView({model:a,el:jQuery("#"+a.get("identifier"))}).render()},renderTemplatesList:function(){var b=this,c=ThriveUlt.objects.savedTemplates.size()>1;this.$templatesList.data("select2")&&this.$templatesList.data("select2").destroy(),this.$templatesList.find("optgroup, option").each(function(b){b>0&&a(this).remove()}),_.every(ThriveUlt.objects.savedTemplates.get("template_groups"),function(d){if(0===d.size())return!0;var e=a('<optgroup label="'+d.group_name+'"></optgroup>');return d.each(function(a){(c?e:b.$templatesList).append('<option value="'+a.get("id")+'">'+a.get("name")+"</option>")}),c&&b.$templatesList.append(e),!0}),this.$templatesList.select2()},loadTemplate:function(){if(""===this.$templatesList.val())return this.tvd_show_errors({field:"load_template",message:ThriveUlt.t.Select_template});var a=ThriveUlt.objects.savedTemplates.get_template({id:this.$templatesList.val()}),b=this;TVE_Dash.showLoader(),jQuery.ajax({url:ajaxurl,data:{action:ThriveUlt.ajax_actions.admin_controller,route:"displaySettingsLoadTemplate",campaign_id:this.model.get("ID"),template_id:this.$templatesList.val(),_nonce:ThriveUlt.admin_nonce}}).done(function(c){b.collection.reset(c),b._render(),TVE_Dash.hideLoader(),TVE_Dash.success(ThriveUlt.util.printf(ThriveUlt.t.template_loaded,a.get("name")))})},saveOptions:function(b){var c={options:[JSON.stringify(this.collection.at(0).getDataForSave()),JSON.stringify(this.collection.at(1).getDataForSave())],campaign_id:this.model.get("ID"),_nonce:ThriveUlt.admin_nonce},d=a(b.target),e=d.html(),f=this;TVE_Dash.showLoader(),this.btnLoading(d),a.ajax({url:ajaxurl+"?action="+ThriveUlt.ajax_actions.admin_controller+"&route=displaySettingsSave",type:"post",dataType:"json",data:c,success:function(a){a.success&&(TVE_Dash.success(ThriveUlt.t.Display_settings_saved),f.close())},error:function(a,b,c){TVE_Dash.err(ThriveUlt.t.GeneralError+" ( Error info: <strong>"+c+"</strong> )")},complete:function(){d.html(e).attr("disabled",!1),TVE_Dash.hideLoader()}})},saveTemplate:function(b){var c=a("input[name='tvu_leads_new_template_name']"),d=this;if(!c.val().trim().length)return void c.addClass("tvd-invalid").focus();var e={name:c.val().trim(),options:[JSON.stringify(this.collection.at(0).getDataForSave()),JSON.stringify(this.collection.at(1).getDataForSave())],_nonce:ThriveUlt.admin_nonce},f=!1;ThriveUlt.objects.savedTemplates.name_exists(e.name,"TU")&&(f=!confirm('"'+e.name+'" template already exists. Do you want to overwrite it ?')),f||(TVE_Dash.showLoader(),a.ajax({type:"post",dataType:"json",data:e,url:ajaxurl+"?action="+ThriveUlt.ajax_actions.admin_controller+"&route=displaySettingsSaveTemplate",success:function(b){if(!b.success)return void TVE_Dash.err(b.message?b.message:ThriveUlt.t.GeneralError);c.val(""),ThriveUlt.objects.savedTemplates=new ThriveUlt.models.TemplateList(b.templates),d.renderTemplatesList(),d.$templatesList.find("option").each(function(){a(this).text()===e.name&&a(this).attr("selected","selected")}),TVE_Dash.success(ThriveUlt.t.DisplaySettingsTemplateSaved)},error:function(a,b,c){TVE_Dash.err(ThriveUlt.t.GeneralError+" ( Error info: <strong>"+c+"</strong> )")},complete:function(){TVE_Dash.hideLoader()}}))},onClose:function(){var a=this.collection.get_display_summary();this.model.set("display_settings_summary",a),ThriveUlt.globals.campaigns.findWhere({ID:this.model.get("ID")}).set("has_display_settings","Not set"!=a)}})})}(jQuery);